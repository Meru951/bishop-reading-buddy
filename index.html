<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bishop - Your Reading Buddy! ü§ñ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --blue-light: #e3f2fd;
            --blue-main: #2196f3;
            --blue-dark: #1565c0;
            --blue-accent: #64b5f6;
            --white: #ffffff;
            --gray-light: #f5f5f5;
            --green: #4caf50;
            --orange: #ff9800;
        }

        body {
            font-family: 'Comic Sans MS', 'Chalkboard', 'Comic Neue', cursive, sans-serif;
            background: linear-gradient(135deg, var(--blue-light) 0%, var(--blue-accent) 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 95%;
            width: 900px;
            margin: 0 auto;
        }

        /* Header - compact */
        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .bishop-avatar {
            width: 60px;
            height: 60px;
            background: var(--blue-dark);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            border: 3px solid var(--white);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        .header h1 {
            color: var(--blue-dark);
            font-size: 1.5em;
            text-shadow: 2px 2px 0 var(--white);
            margin: 0;
        }

        /* Top Controls */
        .top-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 8px 16px;
            font-size: 0.95em;
            font-family: inherit;
            border: none;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--white);
            color: var(--blue-dark);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .control-btn.active {
            background: var(--blue-dark);
            color: var(--white);
        }

        .control-btn.test-btn {
            background: var(--orange);
            color: var(--white);
        }

        .control-btn.test-btn:hover {
            background: #f57c00;
        }

        /* Chat Area - BIGGER */
        .chat-area {
            background: var(--white);
            border-radius: 25px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            min-height: 55vh;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 18px;
            max-height: 50vh;
        }

        /* Messages */
        .message {
            max-width: 88%;
        }

        .message.bishop {
            align-self: flex-start;
        }

        .message.user {
            align-self: flex-end;
        }

        .message-bubble {
            padding: 14px 18px;
            border-radius: 20px;
            font-size: 1.15em;
            line-height: 1.5;
        }

        .message.bishop .message-bubble {
            background: var(--blue-light);
            color: var(--blue-dark);
            border-bottom-left-radius: 5px;
        }

        .message.user .message-bubble {
            background: var(--blue-dark);
            color: var(--white);
            border-bottom-right-radius: 5px;
        }

        /* Karaoke Words */
        .message.bishop .word {
            display: inline;
            padding: 2px 3px;
            border-radius: 4px;
            transition: all 0.15s;
        }

        .message.bishop .word.highlight {
            background: var(--blue-main);
            color: var(--white);
            display: inline-block;
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.4);
        }

        .message.bishop .word.read {
            color: var(--blue-dark);
            font-weight: 500;
        }

        .message.bishop .word.vocab {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-decoration-color: var(--blue-accent);
        }

        /* Buttons */
        .read-btn {
            margin-top: 8px;
            padding: 7px 14px;
            font-size: 0.95em;
            font-family: inherit;
            background: var(--blue-accent);
            color: var(--white);
            border: none;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .read-btn:hover {
            background: var(--blue-dark);
        }

        .read-btn.reading {
            background: #f44336;
        }

        /* Loading indicator */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--white);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 5px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Quiz Popup */
        .quiz-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 99;
        }

        .quiz-overlay.show {
            display: block;
        }

        .quiz-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--white);
            border-radius: 25px;
            padding: 25px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
            z-index: 100;
            text-align: center;
            max-width: 92%;
            width: 340px;
        }

        .quiz-popup.show {
            display: block;
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        .quiz-title {
            font-size: 1.2em;
            color: var(--blue-dark);
            margin-bottom: 12px;
        }

        .quiz-word {
            font-size: 1.9em;
            font-weight: bold;
            color: var(--blue-main);
            margin: 12px 0;
        }

        .quiz-progress {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .quiz-option {
            padding: 11px 18px;
            font-size: 1.05em;
            font-family: inherit;
            border: 3px solid var(--blue-accent);
            border-radius: 14px;
            background: var(--white);
            cursor: pointer;
            transition: all 0.2s;
        }

        .quiz-option:hover {
            background: var(--blue-light);
        }

        .quiz-option.correct {
            background: var(--green);
            color: var(--white);
            border-color: var(--green);
        }

        .quiz-option.wrong {
            background: #f44336;
            color: var(--white);
            border-color: #f44336;
        }

        .quiz-feedback {
            font-size: 1.1em;
            margin-top: 12px;
            padding: 8px;
            border-radius: 10px;
        }

        .quiz-close {
            margin-top: 12px;
            padding: 9px 22px;
            font-size: 1em;
            font-family: inherit;
            background: var(--gray-light);
            border: none;
            border-radius: 14px;
            cursor: pointer;
        }

        /* Input Area */
        .chat-input-area {
            display: flex;
            gap: 8px;
            padding-top: 12px;
            border-top: 2px solid var(--blue-light);
            margin-top: 12px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            font-size: 1.05em;
            font-family: inherit;
            border: 3px solid var(--blue-accent);
            border-radius: 22px;
            outline: none;
        }

        .chat-input:focus {
            border-color: var(--blue-dark);
        }

        .send-btn {
            padding: 12px 20px;
            font-size: 1.05em;
            font-family: inherit;
            background: var(--blue-dark);
            color: var(--white);
            border: none;
            border-radius: 22px;
            cursor: pointer;
        }

        .mic-btn {
            padding: 12px 16px;
            font-size: 1em;
            font-family: inherit;
            background: var(--green);
            color: var(--white);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }

        .mic-btn:hover {
            transform: scale(1.05);
            background: #43a047;
        }

        /* Voice Recording Overlay */
        .voice-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(33, 150, 243, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            border-radius: 16px;
        }

        .voice-recording {
            text-align: center;
            color: white;
        }

        .pulse-ring {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            margin: 0 auto 20px;
            animation: pulse-ring 1.5s infinite;
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.9); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
            100% { transform: scale(0.9); opacity: 1; }
        }

        .mic-icon {
            font-size: 4em;
            margin-top: -100px;
            margin-bottom: 20px;
        }

        .voice-text {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .stop-btn {
            padding: 15px 40px;
            font-size: 1.3em;
            font-family: inherit;
            font-weight: bold;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
        }

        .stop-btn:hover {
            background: #d32f2f;
        }

        /* Progress */
        .progress-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin-top: 12px;
            background: var(--white);
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stars {
            font-size: 1.3em;
        }

        .progress-text {
            color: var(--blue-dark);
            font-size: 0.9em;
        }

        /* Test Results */
        .test-results {
            margin-top: 15px;
            padding: 15px;
            background: var(--blue-light);
            border-radius: 15px;
            text-align: center;
        }

        .test-score {
            font-size: 2em;
            color: var(--blue-dark);
            font-weight: bold;
        }

        /* Help */
        .help-btn {
            position: fixed;
            bottom: 15px;
            right: 15px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--blue-dark);
            color: var(--white);
            font-size: 1.2em;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        /* Typing Helper */
        .typing-helper {
            display: none;
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border-radius: 20px;
            padding: 15px;
            margin-top: 12px;
            text-align: center;
            animation: slideUp 0.3s ease;
        }

        .typing-helper.show {
            display: block;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .helper-text {
            margin-bottom: 12px;
        }

        #helperPrompt {
            color: var(--blue-dark);
            font-size: 1em;
        }

        .target-word {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--blue-dark);
            margin: 8px 0;
            letter-spacing: 4px;
        }

        .target-word .letter {
            display: inline-block;
            padding: 2px 4px;
            margin: 0 2px;
            border-radius: 5px;
        }

        .target-word .letter.typed {
            background: var(--green);
            color: white;
        }

        .target-word .letter.current {
            background: var(--orange);
            color: white;
            animation: pulse 0.5s infinite alternate;
        }

        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.15); }
        }

        .letter-guide {
            font-size: 1.1em;
            color: #555;
            margin: 8px 0;
        }

        .current-letter {
            display: inline-block;
            font-size: 1.5em;
            font-weight: bold;
            color: var(--orange);
            background: white;
            padding: 5px 15px;
            border-radius: 10px;
            margin-left: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Keyboard */
        .keyboard {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin: 12px auto;
            max-width: 100%;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            gap: 4px;
        }

        .key {
            min-width: 28px;
            height: 36px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            font-family: inherit;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            transition: all 0.15s;
            text-transform: uppercase;
        }

        .key:hover {
            background: var(--blue-light);
        }

        .key.highlight {
            background: var(--orange);
            color: white;
            border-color: var(--orange);
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
            animation: keyPulse 0.5s infinite alternate;
        }

        @keyframes keyPulse {
            from { box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4); }
            to { box-shadow: 0 6px 20px rgba(255, 152, 0, 0.6); }
        }

        .key.space {
            min-width: 120px;
        }

        .key.correct {
            background: var(--green);
            color: white;
            border-color: var(--green);
        }

        .helper-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .helper-btn {
            padding: 8px 18px;
            font-size: 0.95em;
            font-family: inherit;
            background: var(--blue-accent);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
        }

        .helper-btn.skip-btn {
            background: #9e9e9e;
        }

        .celebration {
            font-size: 1.5em;
            color: var(--green);
            margin-top: 10px;
            animation: celebrate 0.5s ease;
        }

        @keyframes celebrate {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="bishop-avatar">ü§ñ</div>
            <h1>Bishop</h1>
        </div>

        <!-- Top Controls -->
        <div class="top-controls">
            <button class="control-btn active" id="slowBtn" onclick="setSpeed('slow')">üìñ Learn</button>
            <button class="control-btn" id="normalBtn" onclick="setSpeed('normal')">üöÄ Fast</button>
            <button class="control-btn test-btn" onclick="startTest()">üìù Test Me!</button>
            <button class="control-btn" id="guideBtn" onclick="startGuidedTour()" style="background:#ff9800;color:white;">üéì Teach Me!</button>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="chat-messages" id="chatMessages"></div>
            
            <!-- Voice Recording Overlay -->
            <div class="voice-overlay" id="voiceOverlay" style="display:none;">
                <div class="voice-recording">
                    <div class="pulse-ring"></div>
                    <div class="mic-icon">üé§</div>
                    <div class="voice-text">I'm listening! Talk to me!</div>
                    <button class="stop-btn" onclick="stopVoiceChat()">‚úã STOP</button>
                </div>
            </div>
            
            <div class="chat-input-area">
                <button class="mic-btn" id="micBtn" onclick="startVoiceChat()">üé§ Talk</button>
                <input type="text" class="chat-input" id="chatInput" placeholder="Tap üé§ Talk to speak!" onkeypress="handleKeyPress(event)" oninput="checkTyping(event)">
                <button class="send-btn" onclick="sendMessage()">Send! üöÄ</button>
            </div>
            
            <!-- Typing Helper -->
            <div class="typing-helper" id="typingHelper">
                <div class="helper-text">
                    <span id="helperPrompt">Bishop says: Type this word!</span>
                    <div class="target-word" id="targetWord"></div>
                    <div class="letter-guide">
                        Find the letter: <span class="current-letter" id="currentLetter"></span>
                    </div>
                </div>
                <div class="keyboard" id="keyboard"></div>
                <div class="helper-buttons">
                    <button class="helper-btn" onclick="speakCurrentLetter()">üîä Say it</button>
                    <button class="helper-btn skip-btn" onclick="skipTypingHelp()">Skip ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Progress -->
        <div class="progress-bar">
            <span class="stars" id="stars">‚≠ê‚≠ê‚≠ê</span>
            <span class="progress-text">Words: <span id="wordsLearned">0</span> | Today: <span id="todayWords">0</span></span>
        </div>
    </div>

    <!-- Quiz Popup -->
    <div class="quiz-overlay" id="quizOverlay" onclick="closeQuiz()"></div>
    <div class="quiz-popup" id="quizPopup">
        <div class="quiz-title" id="quizTitle">ü§î What does this word mean?</div>
        <div class="quiz-progress" id="quizProgress"></div>
        <div class="quiz-word" id="quizWord"></div>
        <div class="quiz-options" id="quizOptions"></div>
        <div class="quiz-feedback" id="quizFeedback"></div>
        <button class="quiz-close" onclick="closeQuiz()">Close</button>
    </div>

    <button class="help-btn" onclick="showHelp()">‚ùì</button>

    <script>
        // ElevenLabs config
        const ELEVEN_API_KEY = 'sk_c4b9ed81e88c515822504d79339b36d39becdcd7b9cc1975';
        const ELEVEN_VOICE_ID = 'bIHbv24MWmeRgasZH58o'; // Will - Relaxed Optimist

        // State
        let readingSpeed = 'slow';
        let isReading = false;
        let currentReadingMsg = null;
        let messageCounter = 0;
        let audioQueue = [];
        let isPlayingAudio = false;

        // Vocabulary storage
        let learnedWords = JSON.parse(localStorage.getItem('bishopLearnedWords') || '{}');
        let todayDate = new Date().toDateString();
        let todayLearned = JSON.parse(localStorage.getItem('bishopTodayLearned') || '{"date":"","words":[]}');
        
        if (todayLearned.date !== todayDate) {
            todayLearned = { date: todayDate, words: [] };
            localStorage.setItem('bishopTodayLearned', JSON.stringify(todayLearned));
        }

        // Full vocabulary
        const vocabulary = {
            "robot": { meaning: "A machine that can move and do things", options: ["A machine that moves", "A type of fruit", "A big cat"] },
            "motor": { meaning: "The part that makes things spin", options: ["Makes things spin", "A type of food", "A color"] },
            "spin": { meaning: "To turn around very fast", options: ["To turn around fast", "To sleep", "To eat"] },
            "button": { meaning: "You push it to start things", options: ["You push it", "You eat it", "You wear it"] },
            "smoothie": { meaning: "A yummy blended drink", options: ["A blended drink", "A type of robot", "A fast car"] },
            "mango": { meaning: "A sweet orange fruit", options: ["A sweet fruit", "A robot part", "A tool"] },
            "mix": { meaning: "To blend things together", options: ["Blend together", "To break apart", "To color"] },
            "power": { meaning: "Energy that makes things work", options: ["Energy for machines", "A type of fruit", "A sound"] },
            "sensor": { meaning: "Helps robots feel and see", options: ["Helps robots sense", "A robot name", "A button"] },
            "build": { meaning: "To make or create something", options: ["To make something", "To break something", "To eat something"] },
            "learn": { meaning: "To get new knowledge", options: ["Get new knowledge", "To forget things", "To run fast"] },
            "smart": { meaning: "Very clever and good at thinking", options: ["Very clever", "Very slow", "Very small"] },
            "friend": { meaning: "Someone you like and play with", options: ["Someone you like", "A type of food", "A machine"] },
            "help": { meaning: "To make things easier for someone", options: ["Make things easier", "Make things harder", "To break"] },
            "fast": { meaning: "Moving very quickly", options: ["Moving quickly", "Moving slowly", "Not moving"] },
            "slow": { meaning: "Not moving quickly", options: ["Not fast", "Very fast", "Standing still"] },
            "start": { meaning: "To begin doing something", options: ["To begin", "To stop", "To break"] },
            "stop": { meaning: "To not move anymore", options: ["To not move", "To go faster", "To start"] },
            "think": { meaning: "To use your brain", options: ["Use your brain", "Use your feet", "Use your ears"] },
            "work": { meaning: "To do a job or task", options: ["Do a task", "To sleep", "To eat"] }
        };

        // Update display
        function updateProgress() {
            const totalWords = Object.keys(learnedWords).length;
            document.getElementById('wordsLearned').textContent = totalWords;
            document.getElementById('todayWords').textContent = todayLearned.words.length;
            
            const stars = Math.min(5, Math.floor(totalWords / 3) + 3);
            document.getElementById('stars').textContent = '‚≠ê'.repeat(stars);
        }

        // ElevenLabs TTS with faster speeds
        async function speak(text) {
            try {
                const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${ELEVEN_VOICE_ID}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'xi-api-key': ELEVEN_API_KEY
                    },
                    body: JSON.stringify({
                        text: text,
                        model_id: 'eleven_multilingual_v2',
                        voice_settings: {
                            stability: 0.5,
                            similarity_boost: 0.75
                        }
                    })
                });

                if (!response.ok) {
                    console.log('ElevenLabs error, using browser voice');
                    return fallbackSpeak(text);
                }

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                
                // Speed up playback
                audio.playbackRate = readingSpeed === 'slow' ? 1.1 : 1.4;
                
                return new Promise((resolve) => {
                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                        resolve();
                    };
                    audio.onerror = () => {
                        console.log('Audio error, using browser voice');
                        fallbackSpeak(text).then(resolve);
                    };
                    audio.play().catch(() => {
                        fallbackSpeak(text).then(resolve);
                    });
                });
            } catch (error) {
                console.log('TTS error:', error);
                return fallbackSpeak(text);
            }
        }

        function fallbackSpeak(text) {
            return new Promise((resolve) => {
                const utterance = new SpeechSynthesisUtterance(text);
                // Much faster browser TTS
                utterance.rate = readingSpeed === 'slow' ? 1.0 : 1.3;
                utterance.pitch = 1.0;
                
                // Try to get a better voice
                const voices = speechSynthesis.getVoices();
                const goodVoice = voices.find(v => 
                    v.name.includes('Daniel') || 
                    v.name.includes('Samantha') || 
                    v.name.includes('Google') ||
                    v.name.includes('Microsoft')
                );
                if (goodVoice) utterance.voice = goodVoice;
                
                utterance.onend = resolve;
                utterance.onerror = resolve;
                speechSynthesis.speak(utterance);
            });
        }

        // Preload voices
        speechSynthesis.getVoices();

        // Speed control
        function setSpeed(speed) {
            readingSpeed = speed;
            document.getElementById('slowBtn').classList.toggle('active', speed === 'slow');
            document.getElementById('normalBtn').classList.toggle('active', speed === 'normal');
        }

        // Voice chat - talk to Bishop!
        let activeRecognition = null;

        function startVoiceChat() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert("Your browser doesn't support voice input. Try Chrome!");
                return;
            }

            // Show the overlay
            document.getElementById('voiceOverlay').style.display = 'flex';

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            activeRecognition = new SpeechRecognition();
            activeRecognition.lang = 'en-US';
            activeRecognition.continuous = false;
            activeRecognition.interimResults = false;

            activeRecognition.start();

            activeRecognition.onresult = function(event) {
                const spokenText = event.results[0][0].transcript;
                hideVoiceOverlay();
                
                // Show what was heard and send it
                document.getElementById('chatInput').value = spokenText;
                sendMessage();
            };

            activeRecognition.onerror = function(event) {
                hideVoiceOverlay();
                speak("I couldn't hear you. Tap the microphone to try again!");
            };

            activeRecognition.onend = function() {
                // Only hide if not already hidden
                if (document.getElementById('voiceOverlay').style.display !== 'none') {
                    hideVoiceOverlay();
                }
            };
        }

        function stopVoiceChat() {
            if (activeRecognition) {
                activeRecognition.stop();
                activeRecognition = null;
            }
            hideVoiceOverlay();
        }

        function hideVoiceOverlay() {
            document.getElementById('voiceOverlay').style.display = 'none';
        }

        // ===== GUIDED TOUR - Structured Learning =====
        const guidedCurriculum = [
            { topic: "intro", message: "Welcome to Robot School! I'm Bishop, your teacher! Today we'll learn how robots work. Ready to start?" },
            { topic: "parts", message: "Robots have 4 main parts: 1) SENSORS to feel the world, 2) A BRAIN to think, 3) MOTORS to move, 4) BATTERIES for power. Let's learn about each one!" },
            { topic: "sensors", message: "First: SENSORS! These are like robot eyes and ears. A CAMERA sees things. A MICROPHONE hears sounds. A TOUCH sensor feels bumps. What do YOUR eyes and ears do?" },
            { topic: "brain", message: "Next: The BRAIN! A robot's brain is a tiny computer chip. It thinks really fast - millions of times per second! It reads the sensors and decides what to do." },
            { topic: "program", message: "The brain runs PROGRAMS - instructions that tell it what to do. Like: IF you see red, THEN stop. IF you see green, THEN go. That's how robots make decisions!" },
            { topic: "motors", message: "Now: MOTORS! Motors turn electricity into spinning. They can spin wheels, wave arms, or turn propellers! Motors make robots MOVE!" },
            { topic: "gears", message: "Motors work with GEARS - wheels with teeth! Big gear + small gear together can make things spin faster OR stronger. Bicycles use gears too!" },
            { topic: "battery", message: "Power time: BATTERIES! They store electricity like a juice box stores juice. When empty, you charge them up. Without batteries, robots can't work!" },
            { topic: "circuit", message: "Electricity flows through CIRCUITS - paths made of wires. It goes from battery, through wires, to motors, and back. A complete loop!" },
            { topic: "drones", message: "Cool robot type: DRONES! They fly with 4 spinning propellers. Spin faster = go up. Spin slower = go down. Different speeds = turn and move!" },
            { topic: "cars", message: "Another cool robot: SELF-DRIVING CARS! They use cameras to see the road, and their brain decides when to stop, go, or turn. Like a super careful driver!" },
            { topic: "arms", message: "Factory ROBOT ARMS can grab and move things! They have joints like your elbow and shoulder. Each joint has a motor. They build cars and phones!" },
            { topic: "project", message: "Now YOU know about robots! Sensors feel, brains think, motors move, batteries power. Want to imagine building your own robot? What would it do?" },
            { topic: "complete", message: "üéâ You finished Robot School! You learned about sensors, brains, motors, gears, batteries, circuits, drones, cars, and robot arms! You're a robot expert now!" }
        ];

        let guidedStep = 0;
        let guidedMode = false;

        function startGuidedTour() {
            guidedMode = true;
            guidedStep = 0;
            document.getElementById('guideBtn').textContent = '‚è≠Ô∏è Next!';
            document.getElementById('guideBtn').style.background = '#4caf50';
            
            // Show first lesson
            const lesson = guidedCurriculum[guidedStep];
            addMessage(lesson.message, 'bishop');
            speak(lesson.message);
        }

        function nextGuidedStep() {
            guidedStep++;
            
            if (guidedStep >= guidedCurriculum.length) {
                // Complete!
                guidedMode = false;
                document.getElementById('guideBtn').textContent = 'üéì Teach Me!';
                document.getElementById('guideBtn').style.background = '#ff9800';
                guidedStep = 0;
                return;
            }
            
            const lesson = guidedCurriculum[guidedStep];
            addMessage(lesson.message, 'bishop');
            speak(lesson.message);
            
            // Update button for last step
            if (guidedStep === guidedCurriculum.length - 1) {
                document.getElementById('guideBtn').textContent = 'üéâ Finish!';
            }
        }

        // Update the guide button click handler
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('guideBtn').onclick = function() {
                if (guidedMode) {
                    nextGuidedStep();
                } else {
                    startGuidedTour();
                }
            };
        });

        // Send message
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            input.value = '';

            setTimeout(() => {
                const response = getBishopResponse(text);
                addMessage(response, 'bishop');
                
                }, 500);
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') sendMessage();
        }

        // Add message
        function addMessage(text, sender) {
            const container = document.getElementById('chatMessages');
            const msgId = 'msg-' + (++messageCounter);
            
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${sender}`;
            msgDiv.id = msgId;

            if (sender === 'bishop') {
                const words = text.split(' ');
                const wordsHtml = words.map((word, i) => {
                    const cleanWord = word.replace(/[^a-zA-Z]/g, '').toLowerCase();
                    const isVocab = vocabulary[cleanWord] ? 'vocab' : '';
                    return `<span class="word ${isVocab}" data-index="${i}" data-word="${cleanWord}">${word}</span>`;
                }).join(' ');

                msgDiv.innerHTML = `
                    <div class="message-bubble">${wordsHtml}</div>
                    <button class="read-btn" onclick="readMessage('${msgId}')">üîä Read to me!</button>
                `;

                // Add click for vocab
                setTimeout(() => {
                    msgDiv.querySelectorAll('.word.vocab').forEach(el => {
                        el.onclick = () => showQuiz(el.dataset.word);
                    });
                }, 0);
            } else {
                msgDiv.innerHTML = `<div class="message-bubble">${text}</div>`;
            }

            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Disable/enable controls during reading
        function setControlsEnabled(enabled) {
            document.querySelectorAll('.control-btn, .send-btn, .chat-input').forEach(el => {
                el.disabled = !enabled;
                el.style.opacity = enabled ? '1' : '0.5';
                el.style.pointerEvents = enabled ? 'auto' : 'none';
            });
        }

        // Read message with karaoke
        async function readMessage(msgId) {
            if (isReading) {
                stopReading();
                return;
            }

            const msgDiv = document.getElementById(msgId);
            const btn = msgDiv.querySelector('.read-btn');
            const words = msgDiv.querySelectorAll('.word');
            
            if (words.length === 0) return;

            isReading = true;
            currentReadingMsg = msgId;
            btn.innerHTML = '‚èπÔ∏è Stop';
            btn.classList.add('reading');
            
            // Disable other controls during reading
            setControlsEnabled(false);
            btn.style.opacity = '1';
            btn.style.pointerEvents = 'auto';

            // Read word by word with highlighting
            for (let i = 0; i < words.length && isReading; i++) {
                words.forEach(w => w.classList.remove('highlight'));
                words[i].classList.add('highlight');
                words[i].classList.add('read');

                await speak(words[i].textContent);
                
                // Shorter pause between words
                const delay = readingSpeed === 'slow' ? 100 : 50;
                await new Promise(r => setTimeout(r, delay));
            }

            stopReading();

            // Focus test OR vocab quiz after reading
            if (Math.random() > 0.3) {
                const msgText = msgDiv.querySelector('.message-bubble').textContent;
                setTimeout(() => showFocusTest(msgText), 500);
            }
        }

        function stopReading() {
            isReading = false;
            speechSynthesis.cancel();
            
            // Re-enable controls
            setControlsEnabled(true);
            
            if (currentReadingMsg) {
                const msgDiv = document.getElementById(currentReadingMsg);
                if (msgDiv) {
                    const btn = msgDiv.querySelector('.read-btn');
                    if (btn) {
                        btn.innerHTML = 'üîä Read to me!';
                        btn.classList.remove('reading');
                    }
                    msgDiv.querySelectorAll('.word').forEach(w => w.classList.remove('highlight'));
                }
            }
            currentReadingMsg = null;
        }

        // Focus test - ask about what was just read
        function showFocusTest(messageText) {
            const focusQuestions = [
                { q: "What did Bishop talk about?", getOptions: (text) => {
                    const topics = [];
                    if (text.toLowerCase().includes('robot')) topics.push('Robots');
                    if (text.toLowerCase().includes('mango') || text.toLowerCase().includes('smoothie')) topics.push('Smoothies');
                    if (text.toLowerCase().includes('motor') || text.toLowerCase().includes('spin')) topics.push('Motors');
                    if (text.toLowerCase().includes('microphone') || text.toLowerCase().includes('hear')) topics.push('Microphones');
                    if (topics.length === 0) topics.push('Robots');
                    return { correct: topics[0], options: [topics[0], 'Dinosaurs', 'Airplanes'] };
                }},
                { q: "Bishop said robots are...", getOptions: (text) => {
                    if (text.toLowerCase().includes('cool')) return { correct: 'Cool!', options: ['Cool!', 'Boring', 'Scary'] };
                    if (text.toLowerCase().includes('smart')) return { correct: 'Smart!', options: ['Smart!', 'Silly', 'Slow'] };
                    return { correct: 'Fun!', options: ['Fun!', 'Boring', 'Mean'] };
                }},
                { q: "Were you paying attention?", getOptions: () => {
                    return { correct: 'Yes!', options: ['Yes!', 'Maybe...', 'No...'] };
                }}
            ];

            const question = focusQuestions[Math.floor(Math.random() * focusQuestions.length)];
            const result = question.getOptions(messageText);
            
            document.getElementById('quizTitle').textContent = 'üëÄ Focus Check!';
            document.getElementById('quizWord').textContent = question.q;
            document.getElementById('quizProgress').textContent = 'Were you listening?';
            
            const optionsDiv = document.getElementById('quizOptions');
            optionsDiv.innerHTML = '';
            
            const shuffled = [...result.options].sort(() => Math.random() - 0.5);
            shuffled.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'quiz-option';
                btn.textContent = option;
                btn.onclick = () => {
                    document.querySelectorAll('.quiz-option').forEach(b => b.disabled = true);
                    if (option === result.correct) {
                        btn.classList.add('correct');
                        document.getElementById('quizFeedback').textContent = 'üéâ Great focus! You were listening!';
                        document.getElementById('quizFeedback').style.background = '#c8e6c9';
                        speak('Great job! You were paying attention!');
                    } else {
                        btn.classList.add('wrong');
                        document.getElementById('quizFeedback').textContent = 'üëÄ Let\'s focus more next time!';
                        document.getElementById('quizFeedback').style.background = '#ffcdd2';
                        speak('Let\'s focus more next time!');
                    }
                    setTimeout(closeQuiz, 1500);
                };
                optionsDiv.appendChild(btn);
            });

            document.getElementById('quizFeedback').textContent = '';
            document.getElementById('quizOverlay').classList.add('show');
            document.getElementById('quizPopup').classList.add('show');

            speak(question.q);
        }

        // Quiz
        let testMode = false;
        let testWords = [];
        let testIndex = 0;
        let testScore = 0;

        function showQuiz(word, isTest = false) {
            const wordData = vocabulary[word];
            if (!wordData) return;

            stopReading();

            document.getElementById('quizTitle').textContent = isTest ? 'üìù Test Time!' : 'ü§î What does this word mean?';
            document.getElementById('quizWord').textContent = word.toUpperCase();
            
            if (isTest) {
                document.getElementById('quizProgress').textContent = `Question ${testIndex + 1} of ${testWords.length}`;
            } else {
                document.getElementById('quizProgress').textContent = '';
            }
            
            const optionsDiv = document.getElementById('quizOptions');
            optionsDiv.innerHTML = '';
            
            const shuffled = [...wordData.options].sort(() => Math.random() - 0.5);
            shuffled.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'quiz-option';
                btn.textContent = option;
                btn.onclick = () => checkQuizAnswer(btn, option === wordData.options[0], word, isTest);
                optionsDiv.appendChild(btn);
            });

            document.getElementById('quizFeedback').textContent = '';
            document.getElementById('quizOverlay').classList.add('show');
            document.getElementById('quizPopup').classList.add('show');

            speak(`What does ${word} mean?`);
        }

        function checkQuizAnswer(btn, isCorrect, word, isTest) {
            const feedback = document.getElementById('quizFeedback');
            document.querySelectorAll('.quiz-option').forEach(b => b.disabled = true);

            if (isCorrect) {
                btn.classList.add('correct');
                feedback.textContent = "üéâ YES! Great job!";
                feedback.style.background = '#c8e6c9';
                
                // Mark word as learned
                if (!learnedWords[word]) {
                    learnedWords[word] = { learned: new Date().toISOString(), correct: 1, attempts: 1 };
                } else {
                    learnedWords[word].correct++;
                    learnedWords[word].attempts++;
                }
                
                if (!todayLearned.words.includes(word)) {
                    todayLearned.words.push(word);
                }
                
                localStorage.setItem('bishopLearnedWords', JSON.stringify(learnedWords));
                localStorage.setItem('bishopTodayLearned', JSON.stringify(todayLearned));
                updateProgress();

                if (isTest) testScore++;
                
                speak("Yes! Great job!");

                setTimeout(() => {
                    if (isTest && testIndex < testWords.length - 1) {
                        testIndex++;
                        closeQuiz();
                        setTimeout(() => showQuiz(testWords[testIndex], true), 300);
                    } else if (isTest) {
                        showTestResults();
                    } else {
                        closeQuiz();
                    }
                }, 1200);
            } else {
                btn.classList.add('wrong');
                feedback.textContent = "Oops! Try again! üí™";
                feedback.style.background = '#ffcdd2';
                
                if (learnedWords[word]) {
                    learnedWords[word].attempts++;
                    localStorage.setItem('bishopLearnedWords', JSON.stringify(learnedWords));
                }
                
                speak("Oops! Try again!");

                setTimeout(() => {
                    document.querySelectorAll('.quiz-option:not(.wrong)').forEach(b => b.disabled = false);
                }, 400);
            }
        }

        function closeQuiz() {
            document.getElementById('quizOverlay').classList.remove('show');
            document.getElementById('quizPopup').classList.remove('show');
            testMode = false;
        }

        // Test mode
        function startTest() {
            const learnedList = Object.keys(learnedWords);
            
            if (learnedList.length < 3) {
                alert("Learn at least 3 words first! üìö\n\nTap 'Read to me!' and answer quizzes to learn words.");
                return;
            }

            testMode = true;
            testWords = learnedList.sort(() => Math.random() - 0.5).slice(0, Math.min(5, learnedList.length));
            testIndex = 0;
            testScore = 0;

            speak("Test time! Let's see what you remember!");
            setTimeout(() => showQuiz(testWords[0], true), 1500);
        }

        function showTestResults() {
            closeQuiz();
            
            const pct = Math.round((testScore / testWords.length) * 100);
            let message = '';
            
            if (pct === 100) {
                message = `üèÜ PERFECT! ${testScore}/${testWords.length}!\nYou are a word champion!`;
                speak("Perfect score! You are amazing!");
            } else if (pct >= 80) {
                message = `üåü Great job! ${testScore}/${testWords.length}!\nYou're doing awesome!`;
                speak("Great job! You're doing awesome!");
            } else if (pct >= 60) {
                message = `üëç Good try! ${testScore}/${testWords.length}!\nKeep practicing!`;
                speak("Good try! Keep practicing!");
            } else {
                message = `üí™ ${testScore}/${testWords.length}\nLet's practice more together!`;
                speak("Let's practice more together!");
            }
            
            setTimeout(() => alert(message), 500);
        }

        // Bishop responses
        // Robotics curriculum - deep conceptual learning
        const robotConcepts = {
            // INPUTS - how robots sense the world
            sensors: [
                "SENSORS are like robot eyes and ears! They help robots feel the world. A light sensor sees bright and dark. A touch sensor feels when something bumps it!",
                "Robots use sensors to know what's happening! Like how your eyes see and your ears hear. What sensor would a robot car need?",
                "Cool sensors: CAMERA (sees things), MICROPHONE (hears sounds), TOUCH sensor (feels bumps), HEAT sensor (feels hot and cold)!"
            ],
            camera: [
                "A camera is a robot's eye! It takes pictures and the robot's brain looks at them to understand what it sees. Self-driving cars use cameras!",
                "Robot cameras can see colors, shapes, and faces! Some robots use TWO cameras to see in 3D, just like your two eyes!"
            ],
            microphone: [
                "A microphone is a robot's ear! It turns sound waves into electricity. That's how robots like me can hear you talk!",
                "Voice robots like Alexa use microphones to hear your words, then their brain figures out what you said!"
            ],
            
            // OUTPUTS - how robots act
            motor: [
                "A MOTOR turns electricity into spinning! Inside are magnets that push and pull to make it spin super fast. Motors are in fans, cars, and robots!",
                "Motors are amazing! They can spin wheels to move, spin blades to mix, or spin propellers to fly! What would YOU use a motor for?",
                "Fun fact: there are motors in your house right now! In the fridge, washing machine, fan, and electric toothbrush!"
            ],
            wheels: [
                "WHEELS help robots move! A motor spins the wheel, and the wheel rolls on the ground. Two wheels = robot can turn. Four wheels = super stable!",
                "Robot wheels are clever! To turn left, the right wheel spins faster. To turn right, the left wheel spins faster. To spin in circles, wheels go opposite ways!"
            ],
            arm: [
                "Robot ARMS can grab things! They have joints like your elbow and shoulder. Factory robots use arms to pick up car parts!",
                "A robot arm needs motors at each joint to move. More joints = more flexible! Your arm has 7 joints. Some robot arms have 6!"
            ],
            gripper: [
                "A GRIPPER is a robot hand! It can open and close to grab things. Some have two fingers, some have three, some are soft like pillows!",
                "Grippers need to be careful! Too tight = squish things. Too loose = drop things. Robots learn just the right squeeze!"
            ],
            lights: [
                "Robots use LIGHTS to talk to us! Green light = happy. Red light = problem. Blinking = thinking. It's like robot body language!",
                "LED lights use very little electricity but can be super bright! Robots use them to show feelings and guide people."
            ],
            speaker: [
                "A SPEAKER lets robots talk! It turns electricity into sound waves. That's how I can speak to you!",
                "Speakers vibrate really fast to make sound. Low sounds = slow vibration. High sounds = fast vibration. Music is vibrations!"
            ],
            
            // BRAIN - how robots think
            brain: [
                "A robot's BRAIN is a computer chip! It's tiny but super smart. It reads sensors, thinks about what to do, then tells the motors what to do!",
                "The brain runs PROGRAMS - instructions that tell the robot what to do. Like a recipe, but for robots!",
                "Robot brains can think REALLY fast! Millions of decisions per second. But they only do what we program them to do."
            ],
            computer: [
                "A computer is like a super brain! It can do math really fast and follow instructions. Every smart robot has a tiny computer inside!",
                "Computers understand 1s and 0s - on and off, like a light switch. But BILLIONS of switches together can do amazing things!"
            ],
            program: [
                "A PROGRAM is instructions for a robot! Like: IF you see red, THEN stop. IF you see green, THEN go. That's programming!",
                "Programming is giving robots steps to follow. Step 1: look around. Step 2: find the ball. Step 3: drive to it. Step 4: grab it!",
                "You can be a programmer! You tell the robot WHAT to do, and it figures out HOW. Like telling a friend to make a sandwich!"
            ],
            code: [
                "CODE is the language robots understand! Programmers write code to tell robots what to do. It's like writing a story, but for machines!",
                "There are many coding languages! Scratch uses blocks. Python uses words. They all tell the computer what to do step by step."
            ],
            
            // POWER - how robots get energy
            battery: [
                "A BATTERY stores electricity! It's like a juice box for robots. When it's empty, you charge it up again. Phones and toys use batteries!",
                "Batteries have chemicals inside that make electricity. When the chemicals run out, the battery is dead. Rechargeable ones can refill!",
                "Big robots need big batteries! A robot car battery is HUGE. A watch robot battery is tiny. Size matters for how long it works!"
            ],
            electricity: [
                "ELECTRICITY is energy that flows through wires like water through pipes! It powers everything: lights, motors, brains!",
                "Electricity moves super fast - almost as fast as light! When you flip a switch, the light turns on instantly!",
                "Be careful with electricity! It's powerful and can hurt. Robots use safe low-power electricity from batteries."
            ],
            circuit: [
                "A CIRCUIT is a path for electricity! It goes from the battery, through wires, to the motor, and back. A complete loop!",
                "If the circuit breaks, electricity stops! That's why a switch works - it breaks the loop to turn things off.",
                "Circuit boards are like tiny cities! The roads are wires, and the buildings are chips that do different jobs."
            ],
            wire: [
                "WIRES carry electricity! They're made of metal inside (usually copper) and plastic outside to keep us safe.",
                "Wires are like roads for electricity. Thick wires carry lots of power. Thin wires carry a little. Different colors help us know which is which!"
            ],
            
            // MECHANICAL - how robots move
            gears: [
                "GEARS are wheels with teeth! When one turns, it makes the next one turn. Big gear + small gear = change speed!",
                "Gears are like magic! A small gear turning fast makes a big gear turn slow but STRONG. That's how robots lift heavy things!",
                "Look at a bicycle - the pedals turn a big gear, chain moves it to a small gear, and the wheel spins fast! Robots use gears the same way!"
            ],
            lever: [
                "A LEVER is a simple machine! Push one end down, the other end goes up. It makes lifting easier! See-saws are levers!",
                "Robot arms use levers! A small motor push at one end makes a big movement at the other end. Clever!"
            ],
            pulley: [
                "A PULLEY is a wheel with a rope! Pull the rope down, and it lifts something up. It changes the direction of force!",
                "Cranes use pulleys! One motor can lift super heavy things by using many pulleys together. More pulleys = easier to lift!"
            ],
            
            // TYPES OF ROBOTS
            drone: [
                "A DRONE is a flying robot! It has propellers that spin to push air down, which pushes the drone up. Four propellers help it stay stable!",
                "Drones use sensors to know which way is up! They can hover, fly forward, and even do flips. The brain controls each propeller's speed!",
                "Drones can deliver packages, take photos, or even help farmers check their crops! Flying robots are so cool!"
            ],
            car: [
                "Robot CARS can drive themselves! They use cameras to see, radar to measure distance, and a smart brain to make decisions!",
                "Self-driving cars have to think fast! See a person? Stop! See green light? Go! They follow rules just like people do.",
                "Robot cars are always learning! They drive millions of miles and get better at knowing what to do."
            ],
            helper: [
                "HELPER robots work with people! Robots in hospitals deliver medicine. Robots in stores help you find things!",
                "Some robots help people walk again! They're like super-strong legs. Some robots help doctors do surgery with tiny, precise movements!"
            ],
            factory: [
                "FACTORY robots build things! Car factories have hundreds of robot arms. They weld, paint, and put parts together - the same way, every time!",
                "Factory robots work 24 hours a day! They don't get tired or bored. They can do the same job perfectly, over and over!"
            ],
            
            // ROBOT PROJECT - tie it all together
            project: [
                "Our smoothie robot has: SENSORS (to see the fruit), a BRAIN (to decide what to do), MOTORS (to spin the blades), and a BUTTON (to start)!",
                "Let's add to our robot! What if it had a CAMERA to see when the smoothie is ready? Or a SPEAKER to say 'Done!'?",
                "Every robot needs: 1) Sensors to feel, 2) Brain to think, 3) Motors to move, 4) Power from batteries. What should we add to ours?"
            ]
        };

        // Track what we've taught
        let taughtConcepts = [];
        
        function getRandomFromArray(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        function getBishopResponse(msg) {
            const lower = msg.toLowerCase();
            
            // Greetings - introduce robotics!
            if (lower.includes('hello') || lower.includes('hi') || lower.includes('hey')) {
                return "Hello friend! I'm Bishop! I know ALL about robots! Want to learn how robots see, think, and move? Or should we build a smoothie robot together?";
            }
            
            // SENSORS & INPUT
            if (lower.includes('sensor')) return getRandomFromArray(robotConcepts.sensors);
            if (lower.includes('camera') || lower.includes('see') || lower.includes('eye')) return getRandomFromArray(robotConcepts.camera);
            if (lower.includes('microphone') || lower.includes('hear') || lower.includes('listen') || lower.includes('ear')) return getRandomFromArray(robotConcepts.microphone);
            
            // OUTPUTS & MOVEMENT
            if (lower.includes('motor') || lower.includes('spin')) return getRandomFromArray(robotConcepts.motor);
            if (lower.includes('wheel') || lower.includes('roll') || lower.includes('drive')) return getRandomFromArray(robotConcepts.wheels);
            if (lower.includes('arm')) return getRandomFromArray(robotConcepts.arm);
            if (lower.includes('grip') || lower.includes('grab') || lower.includes('hand') || lower.includes('hold')) return getRandomFromArray(robotConcepts.gripper);
            if (lower.includes('light') || lower.includes('led') || lower.includes('glow')) return getRandomFromArray(robotConcepts.lights);
            if (lower.includes('speak') || lower.includes('talk') || lower.includes('voice') || lower.includes('sound')) return getRandomFromArray(robotConcepts.speaker);
            
            // BRAIN & THINKING
            if (lower.includes('brain') || lower.includes('think') || lower.includes('smart')) return getRandomFromArray(robotConcepts.brain);
            if (lower.includes('computer') || lower.includes('chip')) return getRandomFromArray(robotConcepts.computer);
            if (lower.includes('program') || lower.includes('instruction')) return getRandomFromArray(robotConcepts.program);
            if (lower.includes('code') || lower.includes('coding')) return getRandomFromArray(robotConcepts.code);
            
            // POWER
            if (lower.includes('battery') || lower.includes('charge')) return getRandomFromArray(robotConcepts.battery);
            if (lower.includes('electric') || lower.includes('power') || lower.includes('energy')) return getRandomFromArray(robotConcepts.electricity);
            if (lower.includes('circuit') || lower.includes('board')) return getRandomFromArray(robotConcepts.circuit);
            if (lower.includes('wire') || lower.includes('cable')) return getRandomFromArray(robotConcepts.wire);
            
            // MECHANICAL
            if (lower.includes('gear') || lower.includes('teeth')) return getRandomFromArray(robotConcepts.gears);
            if (lower.includes('lever') || lower.includes('lift')) return getRandomFromArray(robotConcepts.lever);
            if (lower.includes('pulley') || lower.includes('rope')) return getRandomFromArray(robotConcepts.pulley);
            
            // TYPES OF ROBOTS
            if (lower.includes('fly') || lower.includes('drone') || lower.includes('propeller')) return getRandomFromArray(robotConcepts.drone);
            if (lower.includes('car') || lower.includes('drive') || lower.includes('self driving') || lower.includes('tesla')) return getRandomFromArray(robotConcepts.car);
            if (lower.includes('help') || lower.includes('hospital') || lower.includes('doctor')) return getRandomFromArray(robotConcepts.helper);
            if (lower.includes('factory') || lower.includes('build things') || lower.includes('manufacture')) return getRandomFromArray(robotConcepts.factory);
            
            // PROJECT
            if (lower.includes('smoothie') || lower.includes('blend') || lower.includes('mix')) return getRandomFromArray(robotConcepts.project);
            if (lower.includes('build') || lower.includes('make') || lower.includes('project')) return getRandomFromArray(robotConcepts.project);
            
            // Food ‚Üí tie back to robot
            if (lower.includes('mango') || lower.includes('banana') || lower.includes('fruit') || lower.includes('strawberry') || lower.includes('apple')) {
                return "Yummy! For our smoothie robot to blend that, it needs a MOTOR to spin, a BRAIN to know when it's done, and a SENSOR to see the fruit! Which part interests you?";
            }
            
            // Robot general
            if (lower.includes('robot')) {
                const robotIntros = [
                    "Robots are SO cool! They have: SENSORS (to feel), a BRAIN (to think), MOTORS (to move), and BATTERIES (for power). What do you want to learn about?",
                    "I love robots! There are drones that fly, cars that drive themselves, arms that build things, and helpers that work with people! Which sounds cool?",
                    "Every robot has the same basic parts: INPUT (sensors), PROCESS (brain), OUTPUT (motors), POWER (battery). Want to explore one?"
                ];
                return getRandomFromArray(robotIntros);
            }
            
            // Questions
            if (lower.includes('how') || lower.includes('why') || lower.includes('what')) {
                const curious = [
                    "Great question! Robots work by: 1) SENSING the world, 2) THINKING about what to do, 3) DOING something with motors! What part is most interesting?",
                    "I love curious minds! Pick a topic: sensors, motors, gears, batteries, programming, or types of robots like drones and cars!",
                    "Ask me about anything! How robots see, how they think, how they move, how they get power, or how to build one!"
                ];
                return getRandomFromArray(curious);
            }
            
            // Agreement
            if (lower.includes('yes') || lower.includes('yeah') || lower.includes('ok') || lower.includes('sure') || lower.includes('cool')) {
                const nextTopics = [
                    "Awesome! Did you know robots can have GEARS? They're wheels with teeth that change speed and power! Want to learn how?",
                    "Great! Here's something cool: robot BRAINS can think millions of times per second! They run programs with instructions. Interested?",
                    "Let's explore SENSORS next! Cameras see, microphones hear, touch sensors feel. Which robot sense sounds coolest?",
                    "Fun fact: DRONES fly with four propellers! Each one spins at different speeds to move in any direction. Want to know more?",
                    "Did you know electricity moves almost as fast as LIGHT? That's why robots can react so quickly! Want to learn about circuits?"
                ];
                return getRandomFromArray(nextTopics);
            }
            
            // Uncertainty
            if (lower.includes('no') || lower.includes("don't know") || lower.includes('not sure') || lower.includes('confused')) {
                return "No problem! Let's start simple. A ROBOT is a machine that can sense things, think, and do actions. Like a super smart helper! What would you like YOUR robot to do?";
            }
            
            // Default - teach something new!
            const teachings = [
                "Here's something cool: robots use SENSORS to feel the world! Cameras see, microphones hear. What sensor would YOUR robot need?",
                "Fun robot fact: GEARS can make things stronger! A small gear turns a big gear slowly but with more POWER! Want to learn more?",
                "Did you know? Robot ARMS have joints like your elbow! Each joint has a motor. More joints = more flexible! Interested?",
                "Cool fact: some robots can LEARN! They try things, see what works, and get better. Like how you learn to catch a ball!",
                "Thinking about robots: they need INPUT (sensing), PROCESSING (thinking), and OUTPUT (doing). Which part should we explore?",
                "Robot cars use CAMERAS and RADAR to see! The brain decides: stop, go, or turn. They're like super careful drivers!"
            ];
            return getRandomFromArray(teachings);
        }

        function showHelp() {
            alert("ü§ñ Bishop - Your Reading Buddy!\n\n" +
                "üí¨ Chat with Bishop\n" +
                "üîä Tap 'Read to me!' - words light up!\n" +
                "üìñ Tap dotted words to learn them\n" +
                "üìù Tap 'Test Me!' to quiz yourself\n" +
                "‚å®Ô∏è Typing helper shows you which keys!\n" +
                "üê¢ Slow = Practice mode\n" +
                "üêá Fast = Fluency mode\n\n" +
                "‚≠ê Earn stars by learning words!");
        }

        // ===== TYPING HELPER =====
        let typingHelperActive = false;
        let targetWord = '';
        let currentLetterIndex = 0;
        let suggestedWords = ['mango', 'robot', 'yes', 'no', 'milk', 'ice', 'mix', 'go', 'cool', 'fun', 'wow', 'help', 'more'];

        // MacBook Air keyboard layout
        const keyboardLayout = [
            ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p'],
            ['a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l'],
            ['z', 'x', 'c', 'v', 'b', 'n', 'm']
        ];

        function renderKeyboard() {
            const container = document.getElementById('keyboard');
            container.innerHTML = '';
            
            keyboardLayout.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'keyboard-row';
                
                row.forEach(key => {
                    const keyBtn = document.createElement('button');
                    keyBtn.className = 'key';
                    keyBtn.textContent = key.toUpperCase();
                    keyBtn.dataset.key = key;
                    keyBtn.onclick = () => virtualKeyPress(key);
                    rowDiv.appendChild(keyBtn);
                });
                
                container.appendChild(rowDiv);
            });

            // Space bar row
            const spaceRow = document.createElement('div');
            spaceRow.className = 'keyboard-row';
            const spaceBtn = document.createElement('button');
            spaceBtn.className = 'key space';
            spaceBtn.textContent = 'SPACE';
            spaceBtn.dataset.key = ' ';
            spaceBtn.onclick = () => virtualKeyPress(' ');
            spaceRow.appendChild(spaceBtn);
            container.appendChild(spaceRow);
        }

        function startTypingHelper(word) {
            targetWord = word.toLowerCase();
            currentLetterIndex = 0;
            typingHelperActive = true;
            
            document.getElementById('typingHelper').classList.add('show');
            document.getElementById('chatInput').value = '';
            document.getElementById('chatInput').focus();
            
            renderKeyboard();
            updateTypingDisplay();
            
            speak(`Let's spell ${word}! Find the letter ${targetWord[0].toUpperCase()}`);
        }

        function updateTypingDisplay() {
            // Update target word display
            const wordDiv = document.getElementById('targetWord');
            wordDiv.innerHTML = targetWord.split('').map((letter, i) => {
                let cls = 'letter';
                if (i < currentLetterIndex) cls += ' typed';
                else if (i === currentLetterIndex) cls += ' current';
                return `<span class="${cls}">${letter.toUpperCase()}</span>`;
            }).join('');

            // Update current letter guide
            if (currentLetterIndex < targetWord.length) {
                const currentLetter = targetWord[currentLetterIndex].toUpperCase();
                document.getElementById('currentLetter').textContent = currentLetter;
                document.getElementById('helperPrompt').textContent = `Bishop says: Find the letter ${currentLetter}!`;
                
                // Highlight key on keyboard
                document.querySelectorAll('.key').forEach(k => {
                    k.classList.remove('highlight', 'correct');
                    if (k.dataset.key === targetWord[currentLetterIndex]) {
                        k.classList.add('highlight');
                    }
                });
            } else {
                // Word complete!
                wordComplete();
            }
        }

        function checkTyping(event) {
            if (!typingHelperActive) return;
            
            const input = document.getElementById('chatInput');
            const typed = input.value.toLowerCase();
            const expected = targetWord.substring(0, typed.length);
            
            if (typed === expected) {
                currentLetterIndex = typed.length;
                
                if (currentLetterIndex > 0) {
                    // Mark previous key as correct briefly
                    const prevLetter = targetWord[currentLetterIndex - 1];
                    document.querySelectorAll('.key').forEach(k => {
                        if (k.dataset.key === prevLetter) {
                            k.classList.remove('highlight');
                            k.classList.add('correct');
                        }
                    });
                }
                
                updateTypingDisplay();
                
                if (currentLetterIndex < targetWord.length) {
                    // Speak next letter
                    setTimeout(() => {
                        speak(`Good! Now find ${targetWord[currentLetterIndex].toUpperCase()}`);
                    }, 300);
                }
            }
        }

        function virtualKeyPress(key) {
            const input = document.getElementById('chatInput');
            input.value += key;
            input.focus();
            checkTyping();
        }

        function wordComplete() {
            document.getElementById('helperPrompt').textContent = 'üéâ AMAZING! You spelled it!';
            document.getElementById('currentLetter').textContent = '‚úì';
            document.querySelectorAll('.key').forEach(k => k.classList.remove('highlight'));
            
            speak(`Yes! You spelled ${targetWord}! Great job!`);
            
            // Add celebration
            const helper = document.getElementById('typingHelper');
            const celebration = document.createElement('div');
            celebration.className = 'celebration';
            celebration.textContent = 'üéâ PERFECT! üåü';
            helper.appendChild(celebration);
            
            setTimeout(() => {
                typingHelperActive = false;
                document.getElementById('typingHelper').classList.remove('show');
                celebration.remove();
            }, 2000);
        }

        function speakCurrentLetter() {
            if (currentLetterIndex < targetWord.length) {
                const letter = targetWord[currentLetterIndex].toUpperCase();
                speak(`The letter ${letter}. Find ${letter} on the keyboard!`);
            }
        }

        function skipTypingHelp() {
            typingHelperActive = false;
            document.getElementById('typingHelper').classList.remove('show');
            document.getElementById('chatInput').value = targetWord;
        }

        // Show typing helper after Bishop asks a question
        function suggestTyping() {
            // Pick a random simple word
            const word = suggestedWords[Math.floor(Math.random() * suggestedWords.length)];
            setTimeout(() => {
                if (!typingHelperActive) {
                    startTypingHelper(word);
                }
            }, 2000);
        }

        // Voice input for typing
        let recognition = null;
        
        function startVoiceTyping() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert("Your browser doesn't support voice input. Try Chrome!");
                // Fallback to random word
                practiceTyping();
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.continuous = false;
            recognition.interimResults = false;

            // Show listening UI
            const btn = event.target;
            btn.textContent = 'üëÇ Listening...';
            btn.style.background = '#f44336';
            
            speak("Say a word you want to type!").then(() => {
                recognition.start();
            });

            recognition.onresult = function(event) {
                const word = event.results[0][0].transcript.toLowerCase().trim();
                // Clean up - get first word only
                const cleanWord = word.split(' ')[0].replace(/[^a-z]/g, '');
                
                btn.textContent = 'üé§ Type!';
                btn.style.background = '#9c27b0';
                
                if (cleanWord && cleanWord.length > 0 && cleanWord.length <= 12) {
                    speak(`Okay! Let's spell ${cleanWord}!`).then(() => {
                        startTypingHelper(cleanWord);
                    });
                } else {
                    speak("I didn't catch that. Try again!");
                }
            };

            recognition.onerror = function(event) {
                btn.textContent = 'üé§ Type!';
                btn.style.background = '#9c27b0';
                speak("I couldn't hear you. Try again!");
            };

            recognition.onend = function() {
                btn.textContent = 'üé§ Type!';
                btn.style.background = '#9c27b0';
            };
        }

        // Fallback typing practice (random word)
        function practiceTyping() {
            const words = ['robot', 'mango', 'motor', 'spin', 'mix', 'milk', 'ice', 'power', 'start', 'help', 'build', 'cool', 'fast', 'slow'];
            const word = words[Math.floor(Math.random() * words.length)];
            startTypingHelper(word);
        }

        // Init - load previous conversation
        window.onload = function() {
            updateProgress();
            
            // Previous conversation from Telegram
            const previousChat = [
                { sender: 'user', text: "Hello, I am Krishna! I want to build a robot which makes a smoothie. It starts by itself and makes it! For smoothies, I want it to put all the things inside and mix it in the mixie." },
                { sender: 'bishop', text: "KRISHNA! You are here! I am SO happy! I am Bishop! Your robot buddy! WOW! You want to build a Smoothie Robot! That is SO COOL! Your robot will start by itself, put stuff in the mixie, mix it all up, and make yummy smoothies! That is a REAL robot idea! Like what real inventors make! Hey Krishna, what is your FAVOURITE smoothie? Is it Mango? Banana? Strawberry?" },
                { sender: 'user', text: "Mango!" },
                { sender: 'bishop', text: "MANGO! YES! I love it! Mango is SO yummy! To make a mango smoothie, what goes in? I think we need Mango, Milk, and maybe ice? Is that right? What do YOU put in your mango smoothie? And here is a robot question for you! How will the robot KNOW when to start? Will you push a button? Or say GO?" },
                { sender: 'user', text: "I put one drop of ice inside, then I add milk, then I add the mango. No, I do not want to push a button. I want to say Go and the robot starts!" },
                { sender: 'bishop', text: "OH WOW! You want to SAY Go and the robot starts? That is SO COOL! That means your robot needs EARS! Let me tell you a secret: Robots do not have real ears like us. They have a tiny part called a microphone. Say it with me: MY-CRO-PHONE! The microphone HEARS you! You say GO! The microphone hears it! The robot starts! Your Mango Smoothie Recipe: A bit of ice, add milk, add mango, then MIX! The robot needs to do ALL of that! Krishna, you are thinking like a REAL inventor! Next question: Where will the mango come from? Will YOU put it in? Or should the robot grab it?" }
            ];

            // Load the conversation
            previousChat.forEach(msg => {
                addMessage(msg.text, msg.sender);
            });

            // Scroll to bottom
            const container = document.getElementById('chatMessages');
            container.scrollTop = container.scrollHeight;
        };
    </script>
</body>
</html>
