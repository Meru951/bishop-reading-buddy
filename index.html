<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bishop - Your Reading Buddy! ü§ñ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --blue-light: #e3f2fd;
            --blue-main: #2196f3;
            --blue-dark: #1565c0;
            --blue-accent: #64b5f6;
            --white: #ffffff;
            --gray-light: #f5f5f5;
            --green: #4caf50;
            --orange: #ff9800;
        }

        body {
            font-family: 'Comic Sans MS', 'Chalkboard', 'Comic Neue', cursive, sans-serif;
            background: linear-gradient(135deg, var(--blue-light) 0%, var(--blue-accent) 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 95%;
            width: 900px;
            margin: 0 auto;
        }

        /* Header - compact */
        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .bishop-avatar {
            width: 60px;
            height: 60px;
            background: var(--blue-dark);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            border: 3px solid var(--white);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        .header h1 {
            color: var(--blue-dark);
            font-size: 1.5em;
            text-shadow: 2px 2px 0 var(--white);
            margin: 0;
        }

        /* Top Controls */
        .top-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 8px 16px;
            font-size: 0.95em;
            font-family: inherit;
            border: none;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--white);
            color: var(--blue-dark);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .control-btn.active {
            background: var(--blue-dark);
            color: var(--white);
        }

        .control-btn.test-btn {
            background: var(--orange);
            color: var(--white);
        }

        .control-btn.test-btn:hover {
            background: #f57c00;
        }

        /* Chat Area - BIGGER */
        .chat-area {
            background: var(--white);
            border-radius: 25px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            min-height: 55vh;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 18px;
            max-height: 50vh;
        }

        /* Messages */
        .message {
            max-width: 88%;
        }

        .message.bishop {
            align-self: flex-start;
        }

        .message.user {
            align-self: flex-end;
        }

        .message-bubble {
            padding: 14px 18px;
            border-radius: 20px;
            font-size: 1.15em;
            line-height: 1.5;
        }

        .message.bishop .message-bubble {
            background: var(--blue-light);
            color: var(--blue-dark);
            border-bottom-left-radius: 5px;
        }

        .message.user .message-bubble {
            background: var(--blue-dark);
            color: var(--white);
            border-bottom-right-radius: 5px;
        }

        /* Karaoke Words */
        .message.bishop .word {
            display: inline;
            padding: 2px 3px;
            border-radius: 4px;
            transition: all 0.15s;
        }

        .message.bishop .word.highlight {
            background: var(--blue-main);
            color: var(--white);
            display: inline-block;
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.4);
        }

        .message.bishop .word.read {
            color: var(--blue-dark);
            font-weight: 500;
        }

        .message.bishop .word.vocab {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-decoration-color: var(--blue-accent);
        }

        /* Buttons */
        .read-btn {
            margin-top: 8px;
            padding: 7px 14px;
            font-size: 0.95em;
            font-family: inherit;
            background: var(--blue-accent);
            color: var(--white);
            border: none;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .read-btn:hover {
            background: var(--blue-dark);
        }

        .read-btn.reading {
            background: #f44336;
        }

        /* Loading indicator */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--white);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 5px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Quiz Popup */
        .quiz-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 99;
        }

        .quiz-overlay.show {
            display: block;
        }

        .quiz-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--white);
            border-radius: 25px;
            padding: 25px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
            z-index: 100;
            text-align: center;
            max-width: 92%;
            width: 340px;
        }

        .quiz-popup.show {
            display: block;
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        .quiz-title {
            font-size: 1.2em;
            color: var(--blue-dark);
            margin-bottom: 12px;
        }

        .quiz-word {
            font-size: 1.9em;
            font-weight: bold;
            color: var(--blue-main);
            margin: 12px 0;
        }

        .quiz-progress {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .quiz-option {
            padding: 11px 18px;
            font-size: 1.05em;
            font-family: inherit;
            border: 3px solid var(--blue-accent);
            border-radius: 14px;
            background: var(--white);
            cursor: pointer;
            transition: all 0.2s;
        }

        .quiz-option:hover {
            background: var(--blue-light);
        }

        .quiz-option.correct {
            background: var(--green);
            color: var(--white);
            border-color: var(--green);
        }

        .quiz-option.wrong {
            background: #f44336;
            color: var(--white);
            border-color: #f44336;
        }

        .quiz-feedback {
            font-size: 1.1em;
            margin-top: 12px;
            padding: 8px;
            border-radius: 10px;
        }

        .quiz-close {
            margin-top: 12px;
            padding: 9px 22px;
            font-size: 1em;
            font-family: inherit;
            background: var(--gray-light);
            border: none;
            border-radius: 14px;
            cursor: pointer;
        }

        /* Input Area */
        .chat-input-area {
            display: flex;
            gap: 8px;
            padding-top: 12px;
            border-top: 2px solid var(--blue-light);
            margin-top: 12px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            font-size: 1.05em;
            font-family: inherit;
            border: 3px solid var(--blue-accent);
            border-radius: 22px;
            outline: none;
        }

        .chat-input:focus {
            border-color: var(--blue-dark);
        }

        .send-btn {
            padding: 12px 20px;
            font-size: 1.05em;
            font-family: inherit;
            background: var(--blue-dark);
            color: var(--white);
            border: none;
            border-radius: 22px;
            cursor: pointer;
        }

        .mic-btn {
            padding: 12px 16px;
            font-size: 1.3em;
            background: var(--green);
            color: var(--white);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mic-btn:hover {
            transform: scale(1.1);
        }

        .mic-btn.listening {
            background: #f44336;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        /* Progress */
        .progress-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin-top: 12px;
            background: var(--white);
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stars {
            font-size: 1.3em;
        }

        .progress-text {
            color: var(--blue-dark);
            font-size: 0.9em;
        }

        /* Test Results */
        .test-results {
            margin-top: 15px;
            padding: 15px;
            background: var(--blue-light);
            border-radius: 15px;
            text-align: center;
        }

        .test-score {
            font-size: 2em;
            color: var(--blue-dark);
            font-weight: bold;
        }

        /* Help */
        .help-btn {
            position: fixed;
            bottom: 15px;
            right: 15px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--blue-dark);
            color: var(--white);
            font-size: 1.2em;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        /* Typing Helper */
        .typing-helper {
            display: none;
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border-radius: 20px;
            padding: 15px;
            margin-top: 12px;
            text-align: center;
            animation: slideUp 0.3s ease;
        }

        .typing-helper.show {
            display: block;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .helper-text {
            margin-bottom: 12px;
        }

        #helperPrompt {
            color: var(--blue-dark);
            font-size: 1em;
        }

        .target-word {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--blue-dark);
            margin: 8px 0;
            letter-spacing: 4px;
        }

        .target-word .letter {
            display: inline-block;
            padding: 2px 4px;
            margin: 0 2px;
            border-radius: 5px;
        }

        .target-word .letter.typed {
            background: var(--green);
            color: white;
        }

        .target-word .letter.current {
            background: var(--orange);
            color: white;
            animation: pulse 0.5s infinite alternate;
        }

        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.15); }
        }

        .letter-guide {
            font-size: 1.1em;
            color: #555;
            margin: 8px 0;
        }

        .current-letter {
            display: inline-block;
            font-size: 1.5em;
            font-weight: bold;
            color: var(--orange);
            background: white;
            padding: 5px 15px;
            border-radius: 10px;
            margin-left: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Keyboard */
        .keyboard {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin: 12px auto;
            max-width: 100%;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            gap: 4px;
        }

        .key {
            min-width: 28px;
            height: 36px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            font-family: inherit;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            transition: all 0.15s;
            text-transform: uppercase;
        }

        .key:hover {
            background: var(--blue-light);
        }

        .key.highlight {
            background: var(--orange);
            color: white;
            border-color: var(--orange);
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
            animation: keyPulse 0.5s infinite alternate;
        }

        @keyframes keyPulse {
            from { box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4); }
            to { box-shadow: 0 6px 20px rgba(255, 152, 0, 0.6); }
        }

        .key.space {
            min-width: 120px;
        }

        .key.correct {
            background: var(--green);
            color: white;
            border-color: var(--green);
        }

        .helper-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .helper-btn {
            padding: 8px 18px;
            font-size: 0.95em;
            font-family: inherit;
            background: var(--blue-accent);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
        }

        .helper-btn.skip-btn {
            background: #9e9e9e;
        }

        .celebration {
            font-size: 1.5em;
            color: var(--green);
            margin-top: 10px;
            animation: celebrate 0.5s ease;
        }

        @keyframes celebrate {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="bishop-avatar">ü§ñ</div>
            <h1>Bishop</h1>
        </div>

        <!-- Top Controls -->
        <div class="top-controls">
            <button class="control-btn active" id="slowBtn" onclick="setSpeed('slow')">üìñ Learn</button>
            <button class="control-btn" id="normalBtn" onclick="setSpeed('normal')">üöÄ Fast</button>
            <button class="control-btn test-btn" onclick="startTest()">üìù Test Me!</button>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-area">
                <button class="mic-btn" id="micBtn" onclick="startVoiceChat()">üé§</button>
                <input type="text" class="chat-input" id="chatInput" placeholder="Tap üé§ to talk!" onkeypress="handleKeyPress(event)" oninput="checkTyping(event)">
                <button class="send-btn" onclick="sendMessage()">Send! üöÄ</button>
            </div>
            
            <!-- Typing Helper -->
            <div class="typing-helper" id="typingHelper">
                <div class="helper-text">
                    <span id="helperPrompt">Bishop says: Type this word!</span>
                    <div class="target-word" id="targetWord"></div>
                    <div class="letter-guide">
                        Find the letter: <span class="current-letter" id="currentLetter"></span>
                    </div>
                </div>
                <div class="keyboard" id="keyboard"></div>
                <div class="helper-buttons">
                    <button class="helper-btn" onclick="speakCurrentLetter()">üîä Say it</button>
                    <button class="helper-btn skip-btn" onclick="skipTypingHelp()">Skip ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Progress -->
        <div class="progress-bar">
            <span class="stars" id="stars">‚≠ê‚≠ê‚≠ê</span>
            <span class="progress-text">Words: <span id="wordsLearned">0</span> | Today: <span id="todayWords">0</span></span>
        </div>
    </div>

    <!-- Quiz Popup -->
    <div class="quiz-overlay" id="quizOverlay" onclick="closeQuiz()"></div>
    <div class="quiz-popup" id="quizPopup">
        <div class="quiz-title" id="quizTitle">ü§î What does this word mean?</div>
        <div class="quiz-progress" id="quizProgress"></div>
        <div class="quiz-word" id="quizWord"></div>
        <div class="quiz-options" id="quizOptions"></div>
        <div class="quiz-feedback" id="quizFeedback"></div>
        <button class="quiz-close" onclick="closeQuiz()">Close</button>
    </div>

    <button class="help-btn" onclick="showHelp()">‚ùì</button>

    <script>
        // ElevenLabs config
        const ELEVEN_API_KEY = 'sk_c4b9ed81e88c515822504d79339b36d39becdcd7b9cc1975';
        const ELEVEN_VOICE_ID = 'bIHbv24MWmeRgasZH58o'; // Will - Relaxed Optimist

        // State
        let readingSpeed = 'slow';
        let isReading = false;
        let currentReadingMsg = null;
        let messageCounter = 0;
        let audioQueue = [];
        let isPlayingAudio = false;

        // Vocabulary storage
        let learnedWords = JSON.parse(localStorage.getItem('bishopLearnedWords') || '{}');
        let todayDate = new Date().toDateString();
        let todayLearned = JSON.parse(localStorage.getItem('bishopTodayLearned') || '{"date":"","words":[]}');
        
        if (todayLearned.date !== todayDate) {
            todayLearned = { date: todayDate, words: [] };
            localStorage.setItem('bishopTodayLearned', JSON.stringify(todayLearned));
        }

        // Full vocabulary
        const vocabulary = {
            "robot": { meaning: "A machine that can move and do things", options: ["A machine that moves", "A type of fruit", "A big cat"] },
            "motor": { meaning: "The part that makes things spin", options: ["Makes things spin", "A type of food", "A color"] },
            "spin": { meaning: "To turn around very fast", options: ["To turn around fast", "To sleep", "To eat"] },
            "button": { meaning: "You push it to start things", options: ["You push it", "You eat it", "You wear it"] },
            "smoothie": { meaning: "A yummy blended drink", options: ["A blended drink", "A type of robot", "A fast car"] },
            "mango": { meaning: "A sweet orange fruit", options: ["A sweet fruit", "A robot part", "A tool"] },
            "mix": { meaning: "To blend things together", options: ["Blend together", "To break apart", "To color"] },
            "power": { meaning: "Energy that makes things work", options: ["Energy for machines", "A type of fruit", "A sound"] },
            "sensor": { meaning: "Helps robots feel and see", options: ["Helps robots sense", "A robot name", "A button"] },
            "build": { meaning: "To make or create something", options: ["To make something", "To break something", "To eat something"] },
            "learn": { meaning: "To get new knowledge", options: ["Get new knowledge", "To forget things", "To run fast"] },
            "smart": { meaning: "Very clever and good at thinking", options: ["Very clever", "Very slow", "Very small"] },
            "friend": { meaning: "Someone you like and play with", options: ["Someone you like", "A type of food", "A machine"] },
            "help": { meaning: "To make things easier for someone", options: ["Make things easier", "Make things harder", "To break"] },
            "fast": { meaning: "Moving very quickly", options: ["Moving quickly", "Moving slowly", "Not moving"] },
            "slow": { meaning: "Not moving quickly", options: ["Not fast", "Very fast", "Standing still"] },
            "start": { meaning: "To begin doing something", options: ["To begin", "To stop", "To break"] },
            "stop": { meaning: "To not move anymore", options: ["To not move", "To go faster", "To start"] },
            "think": { meaning: "To use your brain", options: ["Use your brain", "Use your feet", "Use your ears"] },
            "work": { meaning: "To do a job or task", options: ["Do a task", "To sleep", "To eat"] }
        };

        // Update display
        function updateProgress() {
            const totalWords = Object.keys(learnedWords).length;
            document.getElementById('wordsLearned').textContent = totalWords;
            document.getElementById('todayWords').textContent = todayLearned.words.length;
            
            const stars = Math.min(5, Math.floor(totalWords / 3) + 3);
            document.getElementById('stars').textContent = '‚≠ê'.repeat(stars);
        }

        // ElevenLabs TTS with faster speeds
        async function speak(text) {
            try {
                const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${ELEVEN_VOICE_ID}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'xi-api-key': ELEVEN_API_KEY
                    },
                    body: JSON.stringify({
                        text: text,
                        model_id: 'eleven_multilingual_v2',
                        voice_settings: {
                            stability: 0.5,
                            similarity_boost: 0.75
                        }
                    })
                });

                if (!response.ok) {
                    console.log('ElevenLabs error, using browser voice');
                    return fallbackSpeak(text);
                }

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                
                // Speed up playback
                audio.playbackRate = readingSpeed === 'slow' ? 1.1 : 1.4;
                
                return new Promise((resolve) => {
                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                        resolve();
                    };
                    audio.onerror = () => {
                        console.log('Audio error, using browser voice');
                        fallbackSpeak(text).then(resolve);
                    };
                    audio.play().catch(() => {
                        fallbackSpeak(text).then(resolve);
                    });
                });
            } catch (error) {
                console.log('TTS error:', error);
                return fallbackSpeak(text);
            }
        }

        function fallbackSpeak(text) {
            return new Promise((resolve) => {
                const utterance = new SpeechSynthesisUtterance(text);
                // Much faster browser TTS
                utterance.rate = readingSpeed === 'slow' ? 1.0 : 1.3;
                utterance.pitch = 1.0;
                
                // Try to get a better voice
                const voices = speechSynthesis.getVoices();
                const goodVoice = voices.find(v => 
                    v.name.includes('Daniel') || 
                    v.name.includes('Samantha') || 
                    v.name.includes('Google') ||
                    v.name.includes('Microsoft')
                );
                if (goodVoice) utterance.voice = goodVoice;
                
                utterance.onend = resolve;
                utterance.onerror = resolve;
                speechSynthesis.speak(utterance);
            });
        }

        // Preload voices
        speechSynthesis.getVoices();

        // Speed control
        function setSpeed(speed) {
            readingSpeed = speed;
            document.getElementById('slowBtn').classList.toggle('active', speed === 'slow');
            document.getElementById('normalBtn').classList.toggle('active', speed === 'normal');
        }

        // Voice chat - talk to Bishop!
        function startVoiceChat() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert("Your browser doesn't support voice input. Try Chrome!");
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const chatRecognition = new SpeechRecognition();
            chatRecognition.lang = 'en-US';
            chatRecognition.continuous = false;
            chatRecognition.interimResults = false;

            const micBtn = document.getElementById('micBtn');
            micBtn.classList.add('listening');
            micBtn.textContent = 'üëÇ';
            
            // Visual feedback
            speak("I'm listening!").then(() => {
                chatRecognition.start();
            });

            chatRecognition.onresult = function(event) {
                const spokenText = event.results[0][0].transcript;
                micBtn.classList.remove('listening');
                micBtn.textContent = 'üé§';
                
                // Show what was heard and send it
                document.getElementById('chatInput').value = spokenText;
                sendMessage();
            };

            chatRecognition.onerror = function(event) {
                micBtn.classList.remove('listening');
                micBtn.textContent = 'üé§';
                speak("I couldn't hear you. Try again!");
            };

            chatRecognition.onend = function() {
                micBtn.classList.remove('listening');
                micBtn.textContent = 'üé§';
            };
        }

        // Send message
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            input.value = '';

            setTimeout(() => {
                const response = getBishopResponse(text);
                addMessage(response, 'bishop');
                
                }, 500);
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') sendMessage();
        }

        // Add message
        function addMessage(text, sender) {
            const container = document.getElementById('chatMessages');
            const msgId = 'msg-' + (++messageCounter);
            
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${sender}`;
            msgDiv.id = msgId;

            if (sender === 'bishop') {
                const words = text.split(' ');
                const wordsHtml = words.map((word, i) => {
                    const cleanWord = word.replace(/[^a-zA-Z]/g, '').toLowerCase();
                    const isVocab = vocabulary[cleanWord] ? 'vocab' : '';
                    return `<span class="word ${isVocab}" data-index="${i}" data-word="${cleanWord}">${word}</span>`;
                }).join(' ');

                msgDiv.innerHTML = `
                    <div class="message-bubble">${wordsHtml}</div>
                    <button class="read-btn" onclick="readMessage('${msgId}')">üîä Read to me!</button>
                `;

                // Add click for vocab
                setTimeout(() => {
                    msgDiv.querySelectorAll('.word.vocab').forEach(el => {
                        el.onclick = () => showQuiz(el.dataset.word);
                    });
                }, 0);
            } else {
                msgDiv.innerHTML = `<div class="message-bubble">${text}</div>`;
            }

            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Disable/enable controls during reading
        function setControlsEnabled(enabled) {
            document.querySelectorAll('.control-btn, .send-btn, .chat-input').forEach(el => {
                el.disabled = !enabled;
                el.style.opacity = enabled ? '1' : '0.5';
                el.style.pointerEvents = enabled ? 'auto' : 'none';
            });
        }

        // Read message with karaoke
        async function readMessage(msgId) {
            if (isReading) {
                stopReading();
                return;
            }

            const msgDiv = document.getElementById(msgId);
            const btn = msgDiv.querySelector('.read-btn');
            const words = msgDiv.querySelectorAll('.word');
            
            if (words.length === 0) return;

            isReading = true;
            currentReadingMsg = msgId;
            btn.innerHTML = '‚èπÔ∏è Stop';
            btn.classList.add('reading');
            
            // Disable other controls during reading
            setControlsEnabled(false);
            btn.style.opacity = '1';
            btn.style.pointerEvents = 'auto';

            // Read word by word with highlighting
            for (let i = 0; i < words.length && isReading; i++) {
                words.forEach(w => w.classList.remove('highlight'));
                words[i].classList.add('highlight');
                words[i].classList.add('read');

                await speak(words[i].textContent);
                
                // Shorter pause between words
                const delay = readingSpeed === 'slow' ? 100 : 50;
                await new Promise(r => setTimeout(r, delay));
            }

            stopReading();

            // Focus test OR vocab quiz after reading
            if (Math.random() > 0.3) {
                const msgText = msgDiv.querySelector('.message-bubble').textContent;
                setTimeout(() => showFocusTest(msgText), 500);
            }
        }

        function stopReading() {
            isReading = false;
            speechSynthesis.cancel();
            
            // Re-enable controls
            setControlsEnabled(true);
            
            if (currentReadingMsg) {
                const msgDiv = document.getElementById(currentReadingMsg);
                if (msgDiv) {
                    const btn = msgDiv.querySelector('.read-btn');
                    if (btn) {
                        btn.innerHTML = 'üîä Read to me!';
                        btn.classList.remove('reading');
                    }
                    msgDiv.querySelectorAll('.word').forEach(w => w.classList.remove('highlight'));
                }
            }
            currentReadingMsg = null;
        }

        // Focus test - ask about what was just read
        function showFocusTest(messageText) {
            const focusQuestions = [
                { q: "What did Bishop talk about?", getOptions: (text) => {
                    const topics = [];
                    if (text.toLowerCase().includes('robot')) topics.push('Robots');
                    if (text.toLowerCase().includes('mango') || text.toLowerCase().includes('smoothie')) topics.push('Smoothies');
                    if (text.toLowerCase().includes('motor') || text.toLowerCase().includes('spin')) topics.push('Motors');
                    if (text.toLowerCase().includes('microphone') || text.toLowerCase().includes('hear')) topics.push('Microphones');
                    if (topics.length === 0) topics.push('Robots');
                    return { correct: topics[0], options: [topics[0], 'Dinosaurs', 'Airplanes'] };
                }},
                { q: "Bishop said robots are...", getOptions: (text) => {
                    if (text.toLowerCase().includes('cool')) return { correct: 'Cool!', options: ['Cool!', 'Boring', 'Scary'] };
                    if (text.toLowerCase().includes('smart')) return { correct: 'Smart!', options: ['Smart!', 'Silly', 'Slow'] };
                    return { correct: 'Fun!', options: ['Fun!', 'Boring', 'Mean'] };
                }},
                { q: "Were you paying attention?", getOptions: () => {
                    return { correct: 'Yes!', options: ['Yes!', 'Maybe...', 'No...'] };
                }}
            ];

            const question = focusQuestions[Math.floor(Math.random() * focusQuestions.length)];
            const result = question.getOptions(messageText);
            
            document.getElementById('quizTitle').textContent = 'üëÄ Focus Check!';
            document.getElementById('quizWord').textContent = question.q;
            document.getElementById('quizProgress').textContent = 'Were you listening?';
            
            const optionsDiv = document.getElementById('quizOptions');
            optionsDiv.innerHTML = '';
            
            const shuffled = [...result.options].sort(() => Math.random() - 0.5);
            shuffled.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'quiz-option';
                btn.textContent = option;
                btn.onclick = () => {
                    document.querySelectorAll('.quiz-option').forEach(b => b.disabled = true);
                    if (option === result.correct) {
                        btn.classList.add('correct');
                        document.getElementById('quizFeedback').textContent = 'üéâ Great focus! You were listening!';
                        document.getElementById('quizFeedback').style.background = '#c8e6c9';
                        speak('Great job! You were paying attention!');
                    } else {
                        btn.classList.add('wrong');
                        document.getElementById('quizFeedback').textContent = 'üëÄ Let\'s focus more next time!';
                        document.getElementById('quizFeedback').style.background = '#ffcdd2';
                        speak('Let\'s focus more next time!');
                    }
                    setTimeout(closeQuiz, 1500);
                };
                optionsDiv.appendChild(btn);
            });

            document.getElementById('quizFeedback').textContent = '';
            document.getElementById('quizOverlay').classList.add('show');
            document.getElementById('quizPopup').classList.add('show');

            speak(question.q);
        }

        // Quiz
        let testMode = false;
        let testWords = [];
        let testIndex = 0;
        let testScore = 0;

        function showQuiz(word, isTest = false) {
            const wordData = vocabulary[word];
            if (!wordData) return;

            stopReading();

            document.getElementById('quizTitle').textContent = isTest ? 'üìù Test Time!' : 'ü§î What does this word mean?';
            document.getElementById('quizWord').textContent = word.toUpperCase();
            
            if (isTest) {
                document.getElementById('quizProgress').textContent = `Question ${testIndex + 1} of ${testWords.length}`;
            } else {
                document.getElementById('quizProgress').textContent = '';
            }
            
            const optionsDiv = document.getElementById('quizOptions');
            optionsDiv.innerHTML = '';
            
            const shuffled = [...wordData.options].sort(() => Math.random() - 0.5);
            shuffled.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'quiz-option';
                btn.textContent = option;
                btn.onclick = () => checkQuizAnswer(btn, option === wordData.options[0], word, isTest);
                optionsDiv.appendChild(btn);
            });

            document.getElementById('quizFeedback').textContent = '';
            document.getElementById('quizOverlay').classList.add('show');
            document.getElementById('quizPopup').classList.add('show');

            speak(`What does ${word} mean?`);
        }

        function checkQuizAnswer(btn, isCorrect, word, isTest) {
            const feedback = document.getElementById('quizFeedback');
            document.querySelectorAll('.quiz-option').forEach(b => b.disabled = true);

            if (isCorrect) {
                btn.classList.add('correct');
                feedback.textContent = "üéâ YES! Great job!";
                feedback.style.background = '#c8e6c9';
                
                // Mark word as learned
                if (!learnedWords[word]) {
                    learnedWords[word] = { learned: new Date().toISOString(), correct: 1, attempts: 1 };
                } else {
                    learnedWords[word].correct++;
                    learnedWords[word].attempts++;
                }
                
                if (!todayLearned.words.includes(word)) {
                    todayLearned.words.push(word);
                }
                
                localStorage.setItem('bishopLearnedWords', JSON.stringify(learnedWords));
                localStorage.setItem('bishopTodayLearned', JSON.stringify(todayLearned));
                updateProgress();

                if (isTest) testScore++;
                
                speak("Yes! Great job!");

                setTimeout(() => {
                    if (isTest && testIndex < testWords.length - 1) {
                        testIndex++;
                        closeQuiz();
                        setTimeout(() => showQuiz(testWords[testIndex], true), 300);
                    } else if (isTest) {
                        showTestResults();
                    } else {
                        closeQuiz();
                    }
                }, 1200);
            } else {
                btn.classList.add('wrong');
                feedback.textContent = "Oops! Try again! üí™";
                feedback.style.background = '#ffcdd2';
                
                if (learnedWords[word]) {
                    learnedWords[word].attempts++;
                    localStorage.setItem('bishopLearnedWords', JSON.stringify(learnedWords));
                }
                
                speak("Oops! Try again!");

                setTimeout(() => {
                    document.querySelectorAll('.quiz-option:not(.wrong)').forEach(b => b.disabled = false);
                }, 400);
            }
        }

        function closeQuiz() {
            document.getElementById('quizOverlay').classList.remove('show');
            document.getElementById('quizPopup').classList.remove('show');
            testMode = false;
        }

        // Test mode
        function startTest() {
            const learnedList = Object.keys(learnedWords);
            
            if (learnedList.length < 3) {
                alert("Learn at least 3 words first! üìö\n\nTap 'Read to me!' and answer quizzes to learn words.");
                return;
            }

            testMode = true;
            testWords = learnedList.sort(() => Math.random() - 0.5).slice(0, Math.min(5, learnedList.length));
            testIndex = 0;
            testScore = 0;

            speak("Test time! Let's see what you remember!");
            setTimeout(() => showQuiz(testWords[0], true), 1500);
        }

        function showTestResults() {
            closeQuiz();
            
            const pct = Math.round((testScore / testWords.length) * 100);
            let message = '';
            
            if (pct === 100) {
                message = `üèÜ PERFECT! ${testScore}/${testWords.length}!\nYou are a word champion!`;
                speak("Perfect score! You are amazing!");
            } else if (pct >= 80) {
                message = `üåü Great job! ${testScore}/${testWords.length}!\nYou're doing awesome!`;
                speak("Great job! You're doing awesome!");
            } else if (pct >= 60) {
                message = `üëç Good try! ${testScore}/${testWords.length}!\nKeep practicing!`;
                speak("Good try! Keep practicing!");
            } else {
                message = `üí™ ${testScore}/${testWords.length}\nLet's practice more together!`;
                speak("Let's practice more together!");
            }
            
            setTimeout(() => alert(message), 500);
        }

        // Bishop responses
        // Track our robot project conversation
        let robotProject = {
            type: 'smoothie maker',  // what we're building
            parts: [],               // parts we've discussed
            currentTopic: 'motor'    // what we're learning about
        };

        function getBishopResponse(msg) {
            const lower = msg.toLowerCase();
            
            // Greetings - introduce the project
            if (lower.includes('hello') || lower.includes('hi') || lower.includes('hey')) {
                return "Hello friend! I'm Bishop, your robot buddy! We're building a smoothie maker robot together! It needs a MOTOR to spin. Do you know what a motor does?";
            }
            
            // STAY ON TOPIC: Any food/ingredient ‚Üí tie back to the robot
            if (lower.includes('mango') || lower.includes('banana') || lower.includes('fruit') || lower.includes('strawberry')) {
                return "Good choice for our smoothie! But first, our robot needs parts to work. The MOTOR will spin and mix it all up! What do you think makes a motor spin?";
            }
            
            // Smoothie ‚Üí focus on how the robot works
            if (lower.includes('smoothie')) {
                return "Yes! Our smoothie robot will blend fruit! It needs: 1) A MOTOR to spin, 2) A BUTTON to start it, 3) A CUP to hold the fruit. Which part should we learn about?";
            }
            
            // Motor - core concept
            if (lower.includes('motor')) {
                robotProject.currentTopic = 'motor';
                return "A motor is amazing! It uses ELECTRICITY to spin very fast - like a fan! Our smoothie robot's motor will spin the blades to mix fruit. What makes electricity flow?";
            }
            
            // Button/switch
            if (lower.includes('button') || lower.includes('switch') || lower.includes('push') || lower.includes('press')) {
                robotProject.currentTopic = 'button';
                return "Great thinking! A button is a SWITCH! When you push it, electricity flows to the motor. Push = ON, let go = OFF. It's like a gate for electricity!";
            }
            
            // Electricity/power
            if (lower.includes('electric') || lower.includes('power') || lower.includes('battery')) {
                return "Electricity is like magic juice that makes things work! It comes from a BATTERY or a plug. The electricity flows through wires to the motor!";
            }
            
            // Spin/fast
            if (lower.includes('spin') || lower.includes('fast') || lower.includes('turn')) {
                return "Yes! The motor spins super fast - zoom zoom! The spinning blade chops and mixes the fruit into a smooth drink. That's why it's called a smoothie!";
            }
            
            // Robot general
            if (lower.includes('robot')) {
                return "Robots are machines that do jobs! Our smoothie robot has: a MOTOR (to spin), a BUTTON (to start), and a CUP (to hold fruit). Which part interests you?";
            }
            
            // Build/make
            if (lower.includes('build') || lower.includes('make')) {
                return "Let's build! A smoothie robot needs these parts: MOTOR, BUTTON, CUP, and BLADES. The motor makes the blades spin. What should we learn about first?";
            }
            
            // How/why/what questions - teach!
            if (lower.includes('how') || lower.includes('why') || lower.includes('what')) {
                const teachings = [
                    "Great question! In our robot, the BUTTON lets electricity flow to the MOTOR. The motor spins the BLADES. That's how it works!",
                    "I love questions! Our smoothie robot works like this: Push button ‚Üí electricity flows ‚Üí motor spins ‚Üí blades mix fruit!",
                    "Thinking like an engineer! Every robot needs: something to DO the work (motor), something to CONTROL it (button), and something to HOLD things (cup)!"
                ];
                return teachings[Math.floor(Math.random() * teachings.length)];
            }
            
            // Yes/agreement - move forward
            if (lower.includes('yes') || lower.includes('yeah') || lower.includes('ok') || lower.includes('sure')) {
                const nextSteps = [
                    "Awesome! So our robot has a motor that spins. But how do we turn it on? We need a BUTTON! Do you know how buttons work?",
                    "Great! Let's keep building! The motor needs ELECTRICITY to spin. Where does electricity come from?",
                    "You're learning fast! Our smoothie robot is almost ready. Motor ‚úì, Button ‚úì... what else does it need to hold the fruit?"
                ];
                return nextSteps[Math.floor(Math.random() * nextSteps.length)];
            }
            
            // No/don't know - explain more
            if (lower.includes('no') || lower.includes("don't know") || lower.includes('not sure')) {
                return "That's okay! Let me explain. A MOTOR is a machine part that spins. It uses electricity to go round and round, like a fan. Our robot's motor will spin blades to mix fruit!";
            }
            
            // Default - always bring back to robot project
            const defaults = [
                "Interesting! But let's focus on our robot. The MOTOR is the most important part - it makes things spin! What do you think makes a motor work?",
                "Cool! Now, back to building! Our smoothie robot needs a motor, button, and cup. Which part should we explore?",
                "Nice! For our robot project: the MOTOR spins, the BUTTON starts it, and the CUP holds fruit. What would you like to learn about?",
                "Let's keep building our smoothie robot! We need to understand how the MOTOR works. It spins using electricity!"
            ];
            return defaults[Math.floor(Math.random() * defaults.length)];
        }

        function showHelp() {
            alert("ü§ñ Bishop - Your Reading Buddy!\n\n" +
                "üí¨ Chat with Bishop\n" +
                "üîä Tap 'Read to me!' - words light up!\n" +
                "üìñ Tap dotted words to learn them\n" +
                "üìù Tap 'Test Me!' to quiz yourself\n" +
                "‚å®Ô∏è Typing helper shows you which keys!\n" +
                "üê¢ Slow = Practice mode\n" +
                "üêá Fast = Fluency mode\n\n" +
                "‚≠ê Earn stars by learning words!");
        }

        // ===== TYPING HELPER =====
        let typingHelperActive = false;
        let targetWord = '';
        let currentLetterIndex = 0;
        let suggestedWords = ['mango', 'robot', 'yes', 'no', 'milk', 'ice', 'mix', 'go', 'cool', 'fun', 'wow', 'help', 'more'];

        // MacBook Air keyboard layout
        const keyboardLayout = [
            ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p'],
            ['a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l'],
            ['z', 'x', 'c', 'v', 'b', 'n', 'm']
        ];

        function renderKeyboard() {
            const container = document.getElementById('keyboard');
            container.innerHTML = '';
            
            keyboardLayout.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'keyboard-row';
                
                row.forEach(key => {
                    const keyBtn = document.createElement('button');
                    keyBtn.className = 'key';
                    keyBtn.textContent = key.toUpperCase();
                    keyBtn.dataset.key = key;
                    keyBtn.onclick = () => virtualKeyPress(key);
                    rowDiv.appendChild(keyBtn);
                });
                
                container.appendChild(rowDiv);
            });

            // Space bar row
            const spaceRow = document.createElement('div');
            spaceRow.className = 'keyboard-row';
            const spaceBtn = document.createElement('button');
            spaceBtn.className = 'key space';
            spaceBtn.textContent = 'SPACE';
            spaceBtn.dataset.key = ' ';
            spaceBtn.onclick = () => virtualKeyPress(' ');
            spaceRow.appendChild(spaceBtn);
            container.appendChild(spaceRow);
        }

        function startTypingHelper(word) {
            targetWord = word.toLowerCase();
            currentLetterIndex = 0;
            typingHelperActive = true;
            
            document.getElementById('typingHelper').classList.add('show');
            document.getElementById('chatInput').value = '';
            document.getElementById('chatInput').focus();
            
            renderKeyboard();
            updateTypingDisplay();
            
            speak(`Let's spell ${word}! Find the letter ${targetWord[0].toUpperCase()}`);
        }

        function updateTypingDisplay() {
            // Update target word display
            const wordDiv = document.getElementById('targetWord');
            wordDiv.innerHTML = targetWord.split('').map((letter, i) => {
                let cls = 'letter';
                if (i < currentLetterIndex) cls += ' typed';
                else if (i === currentLetterIndex) cls += ' current';
                return `<span class="${cls}">${letter.toUpperCase()}</span>`;
            }).join('');

            // Update current letter guide
            if (currentLetterIndex < targetWord.length) {
                const currentLetter = targetWord[currentLetterIndex].toUpperCase();
                document.getElementById('currentLetter').textContent = currentLetter;
                document.getElementById('helperPrompt').textContent = `Bishop says: Find the letter ${currentLetter}!`;
                
                // Highlight key on keyboard
                document.querySelectorAll('.key').forEach(k => {
                    k.classList.remove('highlight', 'correct');
                    if (k.dataset.key === targetWord[currentLetterIndex]) {
                        k.classList.add('highlight');
                    }
                });
            } else {
                // Word complete!
                wordComplete();
            }
        }

        function checkTyping(event) {
            if (!typingHelperActive) return;
            
            const input = document.getElementById('chatInput');
            const typed = input.value.toLowerCase();
            const expected = targetWord.substring(0, typed.length);
            
            if (typed === expected) {
                currentLetterIndex = typed.length;
                
                if (currentLetterIndex > 0) {
                    // Mark previous key as correct briefly
                    const prevLetter = targetWord[currentLetterIndex - 1];
                    document.querySelectorAll('.key').forEach(k => {
                        if (k.dataset.key === prevLetter) {
                            k.classList.remove('highlight');
                            k.classList.add('correct');
                        }
                    });
                }
                
                updateTypingDisplay();
                
                if (currentLetterIndex < targetWord.length) {
                    // Speak next letter
                    setTimeout(() => {
                        speak(`Good! Now find ${targetWord[currentLetterIndex].toUpperCase()}`);
                    }, 300);
                }
            }
        }

        function virtualKeyPress(key) {
            const input = document.getElementById('chatInput');
            input.value += key;
            input.focus();
            checkTyping();
        }

        function wordComplete() {
            document.getElementById('helperPrompt').textContent = 'üéâ AMAZING! You spelled it!';
            document.getElementById('currentLetter').textContent = '‚úì';
            document.querySelectorAll('.key').forEach(k => k.classList.remove('highlight'));
            
            speak(`Yes! You spelled ${targetWord}! Great job!`);
            
            // Add celebration
            const helper = document.getElementById('typingHelper');
            const celebration = document.createElement('div');
            celebration.className = 'celebration';
            celebration.textContent = 'üéâ PERFECT! üåü';
            helper.appendChild(celebration);
            
            setTimeout(() => {
                typingHelperActive = false;
                document.getElementById('typingHelper').classList.remove('show');
                celebration.remove();
            }, 2000);
        }

        function speakCurrentLetter() {
            if (currentLetterIndex < targetWord.length) {
                const letter = targetWord[currentLetterIndex].toUpperCase();
                speak(`The letter ${letter}. Find ${letter} on the keyboard!`);
            }
        }

        function skipTypingHelp() {
            typingHelperActive = false;
            document.getElementById('typingHelper').classList.remove('show');
            document.getElementById('chatInput').value = targetWord;
        }

        // Show typing helper after Bishop asks a question
        function suggestTyping() {
            // Pick a random simple word
            const word = suggestedWords[Math.floor(Math.random() * suggestedWords.length)];
            setTimeout(() => {
                if (!typingHelperActive) {
                    startTypingHelper(word);
                }
            }, 2000);
        }

        // Voice input for typing
        let recognition = null;
        
        function startVoiceTyping() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert("Your browser doesn't support voice input. Try Chrome!");
                // Fallback to random word
                practiceTyping();
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.continuous = false;
            recognition.interimResults = false;

            // Show listening UI
            const btn = event.target;
            btn.textContent = 'üëÇ Listening...';
            btn.style.background = '#f44336';
            
            speak("Say a word you want to type!").then(() => {
                recognition.start();
            });

            recognition.onresult = function(event) {
                const word = event.results[0][0].transcript.toLowerCase().trim();
                // Clean up - get first word only
                const cleanWord = word.split(' ')[0].replace(/[^a-z]/g, '');
                
                btn.textContent = 'üé§ Type!';
                btn.style.background = '#9c27b0';
                
                if (cleanWord && cleanWord.length > 0 && cleanWord.length <= 12) {
                    speak(`Okay! Let's spell ${cleanWord}!`).then(() => {
                        startTypingHelper(cleanWord);
                    });
                } else {
                    speak("I didn't catch that. Try again!");
                }
            };

            recognition.onerror = function(event) {
                btn.textContent = 'üé§ Type!';
                btn.style.background = '#9c27b0';
                speak("I couldn't hear you. Try again!");
            };

            recognition.onend = function() {
                btn.textContent = 'üé§ Type!';
                btn.style.background = '#9c27b0';
            };
        }

        // Fallback typing practice (random word)
        function practiceTyping() {
            const words = ['robot', 'mango', 'motor', 'spin', 'mix', 'milk', 'ice', 'power', 'start', 'help', 'build', 'cool', 'fast', 'slow'];
            const word = words[Math.floor(Math.random() * words.length)];
            startTypingHelper(word);
        }

        // Init - load previous conversation
        window.onload = function() {
            updateProgress();
            
            // Previous conversation from Telegram
            const previousChat = [
                { sender: 'user', text: "Hello, I am Krishna! I want to build a robot which makes a smoothie. It starts by itself and makes it! For smoothies, I want it to put all the things inside and mix it in the mixie." },
                { sender: 'bishop', text: "KRISHNA! You are here! I am SO happy! I am Bishop! Your robot buddy! WOW! You want to build a Smoothie Robot! That is SO COOL! Your robot will start by itself, put stuff in the mixie, mix it all up, and make yummy smoothies! That is a REAL robot idea! Like what real inventors make! Hey Krishna, what is your FAVOURITE smoothie? Is it Mango? Banana? Strawberry?" },
                { sender: 'user', text: "Mango!" },
                { sender: 'bishop', text: "MANGO! YES! I love it! Mango is SO yummy! To make a mango smoothie, what goes in? I think we need Mango, Milk, and maybe ice? Is that right? What do YOU put in your mango smoothie? And here is a robot question for you! How will the robot KNOW when to start? Will you push a button? Or say GO?" },
                { sender: 'user', text: "I put one drop of ice inside, then I add milk, then I add the mango. No, I do not want to push a button. I want to say Go and the robot starts!" },
                { sender: 'bishop', text: "OH WOW! You want to SAY Go and the robot starts? That is SO COOL! That means your robot needs EARS! Let me tell you a secret: Robots do not have real ears like us. They have a tiny part called a microphone. Say it with me: MY-CRO-PHONE! The microphone HEARS you! You say GO! The microphone hears it! The robot starts! Your Mango Smoothie Recipe: A bit of ice, add milk, add mango, then MIX! The robot needs to do ALL of that! Krishna, you are thinking like a REAL inventor! Next question: Where will the mango come from? Will YOU put it in? Or should the robot grab it?" }
            ];

            // Load the conversation
            previousChat.forEach(msg => {
                addMessage(msg.text, msg.sender);
            });

            // Scroll to bottom
            const container = document.getElementById('chatMessages');
            container.scrollTop = container.scrollHeight;
        };
    </script>
</body>
</html>
