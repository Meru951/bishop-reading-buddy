<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bishop - Let's Play Go!</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', 'Chalkboard', cursive, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 450px;
            margin: 0 auto;
        }

        /* Bishop Chat Bubble */
        .bishop-chat {
            background: white;
            border-radius: 25px;
            padding: 15px 20px;
            margin-bottom: 15px;
            position: relative;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .bishop-chat::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 30px;
            border: 15px solid transparent;
            border-top-color: white;
            border-bottom: 0;
        }

        .bishop-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .bishop-avatar {
            font-size: 2.5em;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .bishop-name {
            font-weight: bold;
            color: #3498db;
            font-size: 1.2em;
        }

        .bishop-message {
            font-size: 1.3em;
            line-height: 1.5;
            color: #2c3e50;
        }

        .bishop-message .highlight {
            background: #f39c12;
            color: white;
            padding: 2px 8px;
            border-radius: 8px;
            font-weight: bold;
        }

        /* Sound button */
        .sound-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.2em;
            cursor: pointer;
        }

        /* Game Board */
        .game-area {
            background: #d4a574;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            color: #5d4037;
            font-weight: bold;
            font-size: 1.1em;
        }

        .turn-indicator {
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .score {
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
        }

        /* The Go Board - 5x5 for beginners */
        .go-board {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0;
            background: #c9a66b;
            padding: 10px;
            border-radius: 10px;
            margin: 0 auto;
            max-width: 300px;
        }

        .point {
            width: 55px;
            height: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            background: transparent;
            border: none;
            transition: transform 0.1s;
        }

        .point:active {
            transform: scale(0.95);
        }

        /* Grid lines */
        .point::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .point.center::before {
            background: 
                linear-gradient(to right, transparent 48%, #8b7355 48%, #8b7355 52%, transparent 52%),
                linear-gradient(to bottom, transparent 48%, #8b7355 48%, #8b7355 52%, transparent 52%);
        }

        .point.top::before {
            background: 
                linear-gradient(to right, transparent 48%, #8b7355 48%, #8b7355 52%, transparent 52%),
                linear-gradient(to bottom, transparent 50%, #8b7355 50%, #8b7355 52%, transparent 52%);
        }

        .point.bottom::before {
            background: 
                linear-gradient(to right, transparent 48%, #8b7355 48%, #8b7355 52%, transparent 52%),
                linear-gradient(to bottom, transparent 48%, #8b7355 48%, #8b7355 50%, transparent 50%);
        }

        .point.left::before {
            background: 
                linear-gradient(to right, transparent 50%, #8b7355 50%, #8b7355 52%, transparent 52%),
                linear-gradient(to bottom, transparent 48%, #8b7355 48%, #8b7355 52%, transparent 52%);
        }

        .point.right::before {
            background: 
                linear-gradient(to right, transparent 48%, #8b7355 48%, #8b7355 50%, transparent 50%),
                linear-gradient(to bottom, transparent 48%, #8b7355 48%, #8b7355 52%, transparent 52%);
        }

        .point.top.left::before {
            background: 
                linear-gradient(to right, transparent 50%, #8b7355 50%, #8b7355 52%, transparent 52%),
                linear-gradient(to bottom, transparent 50%, #8b7355 50%, #8b7355 52%, transparent 52%);
        }

        .point.top.right::before {
            background: 
                linear-gradient(to right, transparent 48%, #8b7355 48%, #8b7355 50%, transparent 50%),
                linear-gradient(to bottom, transparent 50%, #8b7355 50%, #8b7355 52%, transparent 52%);
        }

        .point.bottom.left::before {
            background: 
                linear-gradient(to right, transparent 50%, #8b7355 50%, #8b7355 52%, transparent 52%),
                linear-gradient(to bottom, transparent 48%, #8b7355 48%, #8b7355 50%, transparent 50%);
        }

        .point.bottom.right::before {
            background: 
                linear-gradient(to right, transparent 48%, #8b7355 48%, #8b7355 50%, transparent 50%),
                linear-gradient(to bottom, transparent 48%, #8b7355 48%, #8b7355 50%, transparent 50%);
        }

        /* Stones */
        .stone {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            position: relative;
            z-index: 2;
            box-shadow: 2px 3px 5px rgba(0,0,0,0.4);
            animation: dropIn 0.3s ease;
        }

        @keyframes dropIn {
            from { transform: scale(0) translateY(-20px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }

        .stone.black {
            background: radial-gradient(circle at 30% 30%, #555, #111);
        }

        .stone.white {
            background: radial-gradient(circle at 30% 30%, #fff, #ddd);
            border: 1px solid #aaa;
        }

        /* Preview on hover */
        .stone.preview {
            opacity: 0.4;
        }

        /* Highlight for hints */
        .point.hint {
            animation: hintPulse 1s infinite;
        }

        @keyframes hintPulse {
            0%, 100% { background: rgba(46, 204, 113, 0.3); }
            50% { background: rgba(46, 204, 113, 0.6); }
        }

        .point.danger {
            animation: dangerPulse 0.5s infinite;
        }

        @keyframes dangerPulse {
            0%, 100% { background: rgba(231, 76, 60, 0.3); }
            50% { background: rgba(231, 76, 60, 0.6); }
        }

        /* Captured animation */
        .stone.captured {
            animation: captured 0.5s ease forwards;
        }

        @keyframes captured {
            to { transform: scale(0); opacity: 0; }
        }

        /* Celebration */
        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .celebration-content {
            background: white;
            border-radius: 30px;
            padding: 40px;
            text-align: center;
            animation: popIn 0.5s ease;
        }

        @keyframes popIn {
            from { transform: scale(0); }
            50% { transform: scale(1.1); }
            to { transform: scale(1); }
        }

        .celebration-emoji {
            font-size: 4em;
            margin-bottom: 15px;
        }

        .celebration-text {
            font-size: 2em;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .celebration-btn {
            padding: 15px 40px;
            font-size: 1.3em;
            font-family: inherit;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
        }

        /* Bottom buttons */
        .game-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .game-btn {
            padding: 12px 25px;
            font-size: 1.1em;
            font-family: inherit;
            font-weight: bold;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .game-btn:hover {
            transform: scale(1.05);
        }

        .game-btn.hint {
            background: #f39c12;
            color: white;
        }

        .game-btn.reset {
            background: #95a5a6;
            color: white;
        }

        .game-btn.home {
            background: #3498db;
            color: white;
        }

        /* Level indicator */
        .level-bar {
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 10px 20px;
            margin-top: 15px;
            text-align: center;
            color: white;
            font-size: 1.1em;
        }

        .level-stars {
            font-size: 1.5em;
            margin-top: 5px;
        }

        /* Intro Screen */
        .intro-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 20px;
        }

        .intro-card {
            background: white;
            border-radius: 30px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .intro-bishop {
            font-size: 4em;
            margin-bottom: 10px;
            animation: bounce 1s infinite;
        }

        .intro-title {
            font-size: 2em;
            color: #2c3e50;
            margin-bottom: 25px;
        }

        .intro-section {
            display: flex;
            align-items: center;
            gap: 15px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 12px;
            text-align: left;
        }

        .intro-icon {
            font-size: 2.5em;
            min-width: 50px;
            text-align: center;
        }

        .intro-text {
            font-size: 1.1em;
            line-height: 1.4;
            color: #2c3e50;
        }

        .intro-text strong {
            color: #e74c3c;
            font-size: 1.1em;
        }

        .intro-example {
            background: #d4a574;
            border-radius: 15px;
            padding: 15px;
            margin: 20px 0;
        }

        .example-title {
            font-weight: bold;
            color: #5d4037;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .example-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
            max-width: 150px;
            margin: 0 auto 10px;
            background: #c9a66b;
            padding: 10px;
            border-radius: 8px;
        }

        .example-point {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .example-point::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(to right, transparent 45%, #8b7355 45%, #8b7355 55%, transparent 55%),
                linear-gradient(to bottom, transparent 45%, #8b7355 45%, #8b7355 55%, transparent 55%);
        }

        .example-stone {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            position: relative;
            z-index: 2;
            box-shadow: 1px 2px 3px rgba(0,0,0,0.3);
        }

        .example-stone.black {
            background: radial-gradient(circle at 30% 30%, #555, #111);
        }

        .example-stone.white {
            background: radial-gradient(circle at 30% 30%, #fff, #ddd);
        }

        .example-stone.animated {
            animation: popIn 0.5s ease;
        }

        @keyframes popIn {
            from { transform: scale(0); }
            50% { transform: scale(1.2); }
            to { transform: scale(1); }
        }

        .example-stone.captured {
            animation: poof 0.5s ease forwards;
        }

        @keyframes poof {
            to { transform: scale(0); opacity: 0; }
        }

        .example-caption {
            font-size: 1.1em;
            color: #5d4037;
            font-weight: bold;
        }

        .intro-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .intro-btn {
            padding: 18px 40px;
            font-size: 1.4em;
            font-family: inherit;
            font-weight: bold;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(46, 204, 113, 0.4);
            transition: all 0.3s;
        }

        .intro-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 30px rgba(46, 204, 113, 0.5);
        }

        .intro-btn-small {
            padding: 10px 20px;
            font-size: 1em;
            font-family: inherit;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .intro-btn-small:hover {
            background: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Intro Screen - explains the game FIRST -->
        <div class="intro-screen" id="introScreen">
            <div class="intro-card">
                <div class="intro-bishop">ü§ñ</div>
                <h1 class="intro-title">Let's Play GO!</h1>
                
                <div class="intro-section">
                    <div class="intro-icon">üéØ</div>
                    <div class="intro-text">
                        <strong>What's the goal?</strong><br>
                        Capture the other player's stones!
                    </div>
                </div>
                
                <div class="intro-section">
                    <div class="intro-icon">‚ö´</div>
                    <div class="intro-text">
                        <strong>How do you capture?</strong><br>
                        Surround a stone on ALL sides ‚Äî then it's yours!
                    </div>
                </div>
                
                <div class="intro-section">
                    <div class="intro-icon">üèÜ</div>
                    <div class="intro-text">
                        <strong>How do you win?</strong><br>
                        Capture more stones than me!
                    </div>
                </div>

                <div class="intro-example">
                    <div class="example-title">Watch! This is how you capture:</div>
                    <div class="example-board" id="exampleBoard"></div>
                    <div class="example-caption" id="exampleCaption">White stone in the middle...</div>
                </div>
                
                <div class="intro-buttons">
                    <button class="intro-btn-small" onclick="playIntroNarration()">üîä Hear it again</button>
                    <button class="intro-btn" onclick="startGame()">Got it! Let's Play! üéÆ</button>
                </div>
            </div>
        </div>

        <!-- Bishop talks here -->
        <div class="bishop-chat" id="bishopChat" style="display:none;">
            <button class="sound-btn" onclick="speakMessage()">üîä</button>
            <div class="bishop-header">
                <span class="bishop-avatar">ü§ñ</span>
                <span class="bishop-name">Bishop</span>
            </div>
            <div class="bishop-message" id="bishopMessage">
                Hey Krishna! Let's play <span class="highlight">GO</span>! 
                Tap anywhere to put down a <span class="highlight">black stone</span>! ‚ö´
            </div>
        </div>

        <!-- Game Area -->
        <div class="game-area" style="display:none;">
            <div class="game-header">
                <div class="turn-indicator">
                    <span id="turnStone">‚ö´</span>
                    <span id="turnText">Your turn!</span>
                </div>
                <div class="score">
                    üéØ <span id="captureCount">0</span> captured
                </div>
            </div>

            <div class="go-board" id="board"></div>

            <div class="game-buttons">
                <button class="game-btn hint" onclick="giveHint()">üí° Help!</button>
                <button class="game-btn reset" onclick="resetGame()">üîÑ New</button>
                <a href="krishna.html" class="game-btn home">üè†</a>
            </div>
        </div>

        <!-- Progress -->
        <div class="level-bar" style="display:none;">
            <div>Level <span id="level">1</span>: <span id="levelName">First Steps</span></div>
            <div class="level-stars" id="stars">‚≠ê</div>
        </div>
    </div>

    <!-- Celebration popup -->
    <div class="celebration" id="celebration" style="display:none;">
        <div class="celebration-content">
            <div class="celebration-emoji" id="celebEmoji">üéâ</div>
            <div class="celebration-text" id="celebText">Amazing!</div>
            <button class="celebration-btn" onclick="nextChallenge()">Next! ‚Üí</button>
        </div>
    </div>

    <script>
        // Game state
        let board = Array(25).fill(null);
        let currentPlayer = 'black'; // Krishna is always black
        let captureCount = 0;
        let level = 1;
        let moveCount = 0;
        let lastMessage = '';

        // Levels - progressive challenges with 6-year-old friendly language
        const levels = [
            {
                name: "Tap to Play!",
                intro: "Your turn! Tap anywhere to put down YOUR stone! You're <span class='highlight'>BLACK ‚ö´</span>!",
                goal: "place3",
                goalCount: 3,
                setup: [],
                hint: "Just tap anywhere on the brown board! That's where your stone goes!"
            },
            {
                name: "Taking Turns",
                intro: "Now we take turns! You put a black stone ‚ö´, then I put a white stone ‚ö™. Just like any game!",
                goal: "place5",
                goalCount: 5,
                setup: [],
                hint: "Keep tapping to put down your stones! I'll put mine after you."
            },
            {
                name: "Capture Time!",
                intro: "See my white stone? <span class='highlight'>Trap it!</span> Put YOUR stones on ALL 4 sides ‚Äî top, bottom, left, right!",
                goal: "capture",
                goalCount: 1,
                setup: [{pos: 12, color: 'white'}],
                hint: "Put black stones above it, below it, left of it, and right of it! All 4 sides!",
                highlightTarget: 12
            },
            {
                name: "Easy Corner!",
                intro: "Corners are EASY! This stone only has <span class='highlight'>2 sides</span> to trap! Just put stones on those 2 sides!",
                goal: "capture",
                goalCount: 1,
                setup: [{pos: 0, color: 'white'}],
                hint: "The corner only touches 2 spots! Put a stone to the right, and one below!",
                highlightTarget: 0
            },
            {
                name: "Edge Trap!",
                intro: "Stones on the edge have <span class='highlight'>3 sides</span>. Trap all 3 and you capture it!",
                goal: "capture",
                goalCount: 1,
                setup: [{pos: 2, color: 'white'}],
                hint: "This stone is on the top edge. Put stones on the left, right, and below it!",
                highlightTarget: 2
            },
            {
                name: "Help Your Friend!",
                intro: "Oh no! Your stone is almost trapped! <span class='highlight'>Put another stone NEXT to it</span> to save it! Friends help friends!",
                goal: "connect",
                goalCount: 1,
                setup: [{pos: 12, color: 'black'}, {pos: 7, color: 'white'}, {pos: 11, color: 'white'}, {pos: 17, color: 'white'}],
                hint: "Put a black stone right next to your other black stone ‚Äî they become friends and share space!",
                highlightTarget: 12,
                dangerStone: 12
            },
            {
                name: "Double Trouble!",
                intro: "Two white stones together! They're <span class='highlight'>friends sharing sides</span>. You need to trap them BOTH at once!",
                goal: "capture",
                goalCount: 2,
                setup: [{pos: 11, color: 'white'}, {pos: 12, color: 'white'}],
                hint: "Surround BOTH white stones together. Cover all the empty spots touching them!",
                highlightTarget: 11
            },
            {
                name: "You're a Go Player!",
                intro: "You know how to play GO! üéâ Now just have fun! Try to capture more stones than me!",
                goal: "capture",
                goalCount: 3,
                setup: [],
                hint: "Surround my white stones to capture them! Remember: cover ALL sides!"
            }
        ];

        // Initialize
        function init() {
            // Show intro first with animated example
            showIntroAnimation();
        }

        let introPlayed = false;

        function showIntroAnimation() {
            const board = document.getElementById('exampleBoard');
            board.innerHTML = '';
            
            // Create 3x3 mini board
            for (let i = 0; i < 9; i++) {
                const point = document.createElement('div');
                point.className = 'example-point';
                point.id = 'ex' + i;
                board.appendChild(point);
            }

            // Animate the capture example
            const caption = document.getElementById('exampleCaption');

            // Play audio intro ONCE
            if (!introPlayed) {
                introPlayed = true;
                playIntroNarration();
            }
            
            // Step 1: White stone appears in center
            setTimeout(() => {
                const center = document.getElementById('ex4');
                const white = document.createElement('div');
                white.className = 'example-stone white animated';
                white.id = 'whiteStone';
                center.appendChild(white);
                caption.textContent = "Here's a white stone ‚ö™";
            }, 500);

            // Step 2: Black stones surround it
            setTimeout(() => {
                const top = document.getElementById('ex1');
                const b1 = document.createElement('div');
                b1.className = 'example-stone black animated';
                top.appendChild(b1);
                caption.textContent = "Put black stones around it...";
            }, 1500);

            setTimeout(() => {
                const left = document.getElementById('ex3');
                const b2 = document.createElement('div');
                b2.className = 'example-stone black animated';
                left.appendChild(b2);
            }, 2000);

            setTimeout(() => {
                const right = document.getElementById('ex5');
                const b3 = document.createElement('div');
                b3.className = 'example-stone black animated';
                right.appendChild(b3);
            }, 2500);

            setTimeout(() => {
                const bottom = document.getElementById('ex7');
                const b4 = document.createElement('div');
                b4.className = 'example-stone black animated';
                bottom.appendChild(b4);
                caption.textContent = "Surround ALL sides...";
            }, 3000);

            // Step 3: White stone captured!
            setTimeout(() => {
                const white = document.getElementById('whiteStone');
                if (white) white.classList.add('captured');
                caption.innerHTML = "CAPTURED! üéâ";
            }, 4000);

            // Repeat animation
            setTimeout(() => {
                showIntroAnimation();
            }, 6000);
        }

        function playIntroNarration() {
            // Simple, friendly narration - explain every hard word
            const narration = `
                Hey Krishna! Welcome to Go!
                This is a really fun game. Let me tell you how to play.
                You use black stones. I use white stones.
                Your job is to capture my stones. Capture means to catch them and take them away!
                How do you capture? You surround them.
                Surround means you put your stones all around mine. On every side. So mine can't escape!
                Watch the picture. See the white stone in the middle?
                Now black stones go on top. On the left. On the right. On the bottom.
                The white stone is trapped! It can't get out! 
                And poof! It's captured! It disappears!
                That's how you win. You trap my stones by putting yours all around them.
                When you're ready to try, tap the green button!
            `;
            speakNaturally(narration);
        }

        function speakNaturally(text) {
            // Break into sentences for natural pacing
            const sentences = text.trim().split(/[.!?]+/).filter(s => s.trim());
            let delay = 0;
            
            sentences.forEach((sentence, i) => {
                setTimeout(() => {
                    const utterance = new SpeechSynthesisUtterance(sentence.trim());
                    utterance.rate = 1.0;  // Normal speed
                    utterance.pitch = 1.1;  // Friendly tone
                    
                    // Try to get a good voice
                    const voices = speechSynthesis.getVoices();
                    const goodVoice = voices.find(v => 
                        v.name.includes('Samantha') || 
                        v.name.includes('Daniel') || 
                        v.name.includes('Google') ||
                        v.lang.startsWith('en')
                    );
                    if (goodVoice) utterance.voice = goodVoice;
                    
                    speechSynthesis.speak(utterance);
                }, delay);
                
                // Estimate time for each sentence + pause
                delay += (sentence.length * 50) + 300;
            });
        }

        function startGame() {
            document.getElementById('introScreen').style.display = 'none';
            document.getElementById('bishopChat').style.display = 'block';
            document.querySelector('.game-area').style.display = 'block';
            document.querySelector('.level-bar').style.display = 'block';
            loadLevel(level);
            speak("Alright Krishna! Your turn. Tap to place a black stone!");
        }

        function loadLevel(lvl) {
            level = lvl;
            moveCount = 0;
            captureCount = 0;
            board = Array(25).fill(null);
            currentPlayer = 'black';

            const levelData = levels[Math.min(lvl - 1, levels.length - 1)];
            
            // Setup initial stones
            levelData.setup.forEach(s => {
                board[s.pos] = s.color;
            });

            // Update UI
            document.getElementById('level').textContent = lvl;
            document.getElementById('levelName').textContent = levelData.name;
            document.getElementById('stars').textContent = '‚≠ê'.repeat(Math.min(lvl, 5));
            document.getElementById('captureCount').textContent = '0';
            
            say(levelData.intro);
            renderBoard();

            // Highlight target if any
            if (levelData.highlightTarget !== undefined) {
                setTimeout(() => {
                    const points = document.querySelectorAll('.point');
                    points[levelData.highlightTarget].classList.add('hint');
                }, 500);
            }
            if (levelData.dangerStone !== undefined) {
                setTimeout(() => {
                    const points = document.querySelectorAll('.point');
                    points[levelData.dangerStone].classList.add('danger');
                }, 500);
            }
        }

        function renderBoard() {
            const boardEl = document.getElementById('board');
            boardEl.innerHTML = '';

            for (let i = 0; i < 25; i++) {
                const point = document.createElement('button');
                point.className = 'point';
                
                // Edge classes
                const row = Math.floor(i / 5);
                const col = i % 5;
                
                let edgeClass = 'center';
                if (row === 0) edgeClass = 'top';
                if (row === 4) edgeClass = 'bottom';
                if (col === 0) edgeClass += ' left';
                if (col === 4) edgeClass += ' right';
                point.className = `point ${edgeClass.trim()}`;

                // Add stone if present
                if (board[i]) {
                    const stone = document.createElement('div');
                    stone.className = `stone ${board[i]}`;
                    point.appendChild(stone);
                }

                point.onclick = () => placeStone(i);
                point.onmouseenter = () => showPreview(i);
                point.onmouseleave = () => hidePreview(i);
                
                boardEl.appendChild(point);
            }
        }

        function showPreview(pos) {
            if (board[pos] || currentPlayer !== 'black') return;
            const points = document.querySelectorAll('.point');
            const preview = document.createElement('div');
            preview.className = 'stone black preview';
            points[pos].appendChild(preview);
        }

        function hidePreview(pos) {
            const points = document.querySelectorAll('.point');
            const preview = points[pos].querySelector('.preview');
            if (preview) preview.remove();
        }

        function placeStone(pos) {
            if (board[pos]) {
                say("That spot is taken! Try an empty one! üòä");
                return;
            }

            // Place Krishna's stone
            board[pos] = 'black';
            moveCount++;
            renderBoard();

            // Check for captures
            const captured = checkCaptures('white');
            
            // Teaching moments based on what happened
            if (captured > 0) {
                captureCount += captured;
                document.getElementById('captureCount').textContent = captureCount;
                celebrateCapture(captured);
                checkGoal();
                return;
            }

            // Check level goals
            const levelData = levels[Math.min(level - 1, levels.length - 1)];
            
            if (levelData.goal === 'place3' && moveCount >= 3) {
                celebrate("You placed 3 stones!", "‚ö´‚ö´‚ö´");
                return;
            }
            
            if (levelData.goal === 'connect') {
                // Check if Krishna connected to save the stone
                const group = getGroup(12, 'black');
                if (group.size > 1) {
                    const liberties = getLiberties(group);
                    if (liberties.size > 0) {
                        celebrate("You saved your stone!", "üí™");
                        return;
                    }
                }
            }

            // Give encouraging feedback
            const encouragements = [
                "Nice move! ‚ö´",
                "Good one! üëç",
                "Keep going! üéØ",
                "You're doing great! ‚≠ê"
            ];
            say(encouragements[Math.floor(Math.random() * encouragements.length)]);

            // Bishop plays (white) after a short delay
            if (level >= 2) {
                setTimeout(() => {
                    bishopPlays();
                }, 800);
            }
        }

        function bishopPlays() {
            // Simple AI - play somewhere useful
            const empty = [];
            for (let i = 0; i < 25; i++) {
                if (!board[i]) empty.push(i);
            }
            
            if (empty.length === 0) return;

            // Try to play near existing stones or center
            let bestMove = empty[Math.floor(Math.random() * empty.length)];
            
            // Prefer center area
            const centerish = [6, 7, 8, 11, 12, 13, 16, 17, 18];
            const goodMoves = empty.filter(p => centerish.includes(p));
            if (goodMoves.length > 0) {
                bestMove = goodMoves[Math.floor(Math.random() * goodMoves.length)];
            }

            board[bestMove] = 'white';
            renderBoard();

            // Check if Bishop captured Krishna's stone (uh oh moment!)
            const captured = checkCaptures('black');
            if (captured > 0) {
                say("Oops! I captured your stone! üòÆ Try to protect them next time!");
            } else {
                const responses = [
                    "My turn! ‚ö™",
                    "I'll go here! ‚ö™",
                    "Your turn now! ‚ö´"
                ];
                say(responses[Math.floor(Math.random() * responses.length)]);
            }

            currentPlayer = 'black';
            document.getElementById('turnStone').textContent = '‚ö´';
            document.getElementById('turnText').textContent = "Your turn!";
        }

        function checkCaptures(colorToCapture) {
            const captured = [];
            const checked = new Set();

            for (let i = 0; i < 25; i++) {
                if (board[i] === colorToCapture && !checked.has(i)) {
                    const group = getGroup(i, colorToCapture);
                    group.forEach(p => checked.add(p));
                    
                    const liberties = getLiberties(group);
                    if (liberties.size === 0) {
                        group.forEach(p => captured.push(p));
                    }
                }
            }

            if (captured.length > 0) {
                // Animate capture
                const points = document.querySelectorAll('.point');
                captured.forEach(pos => {
                    const stone = points[pos].querySelector('.stone');
                    if (stone) stone.classList.add('captured');
                });

                setTimeout(() => {
                    captured.forEach(pos => board[pos] = null);
                    renderBoard();
                }, 500);
            }

            return captured.length;
        }

        function getGroup(pos, color) {
            const group = new Set();
            const stack = [pos];
            
            while (stack.length > 0) {
                const p = stack.pop();
                if (group.has(p)) continue;
                if (board[p] !== color) continue;
                
                group.add(p);
                getNeighbors(p).forEach(n => {
                    if (board[n] === color && !group.has(n)) {
                        stack.push(n);
                    }
                });
            }
            return group;
        }

        function getLiberties(group) {
            const liberties = new Set();
            group.forEach(pos => {
                getNeighbors(pos).forEach(n => {
                    if (board[n] === null) liberties.add(n);
                });
            });
            return liberties;
        }

        function getNeighbors(pos) {
            const neighbors = [];
            const row = Math.floor(pos / 5);
            const col = pos % 5;
            if (row > 0) neighbors.push(pos - 5);
            if (row < 4) neighbors.push(pos + 5);
            if (col > 0) neighbors.push(pos - 1);
            if (col < 4) neighbors.push(pos + 1);
            return neighbors;
        }

        function celebrateCapture(count) {
            const messages = [
                ["You captured it!", "üéØ"],
                ["BOOM! Captured!", "üí•"],
                ["Got it!", "‚≠ê"],
                ["Amazing capture!", "üéâ"]
            ];
            const msg = messages[Math.floor(Math.random() * messages.length)];
            
            if (count > 1) {
                celebrate(`${count} stones captured!`, "üéâüéâ");
            } else {
                say(`${msg[0]} ${msg[1]}`);
            }
        }

        function checkGoal() {
            const levelData = levels[Math.min(level - 1, levels.length - 1)];
            
            if (levelData.goal === 'capture' && captureCount >= levelData.goalCount) {
                setTimeout(() => {
                    celebrate("Level Complete!", "üèÜ");
                }, 1000);
            }
        }

        function celebrate(text, emoji) {
            document.getElementById('celebText').textContent = text;
            document.getElementById('celebEmoji').textContent = emoji;
            document.getElementById('celebration').style.display = 'flex';
            speak(text);
        }

        function nextChallenge() {
            document.getElementById('celebration').style.display = 'none';
            if (level < levels.length) {
                loadLevel(level + 1);
            } else {
                loadLevel(levels.length); // Stay on free play
            }
        }

        function giveHint() {
            const levelData = levels[Math.min(level - 1, levels.length - 1)];
            say(levelData.hint);
        }

        function resetGame() {
            loadLevel(level);
        }

        function say(message) {
            document.getElementById('bishopMessage').innerHTML = message;
            lastMessage = message.replace(/<[^>]*>/g, ''); // Strip HTML for speech
        }

        function speakMessage() {
            speak(lastMessage);
        }

        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1.0;
            speechSynthesis.speak(utterance);
        }

        // Start!
        init();
    </script>
</body>
</html>
